---
password: ""
icon: ""
date: "2024-03-01"
type: Post
category: åŠ¨æ‰‹å®è·µ
slug: Graduation-Design
tags:
  - å®ç”¨æ•™ç¨‹
summary: è¿™ç¯‡æ–‡ç« éšè¿›åº¦æ›´æ–°ï¼Œç”¨äºè®°å½•åœ¨æ¯•è®¾è¿‡ç¨‹ä¸­é‡åˆ°çš„å¿ƒå¾—å’Œé—®é¢˜ã€‚
title: "[æ¯•ä¸šè®¾è®¡] åŸºäºYoloçš„èˆªæ‹å›¾åƒé»‘åŒ£å­æ£€æµ‹ç®—æ³•è®¾è®¡"
status: Published
urlname: 4953c12f-b064-475e-aa3b-1a7019651192
updated: "2024-04-14 08:22:00"
---

# å‰è¨€

---

> ğŸ’¡ é¦–å…ˆéœ€è¦æ„Ÿè°¢å­¦æ ¡ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªè‰¯å¥½çš„å­¦ä¹ å¹³å°ï¼Œè®©æˆ‘ä»¬é€šè¿‡æ¯•è®¾æ¥äº†è§£é¡¹ç›®å¼€å‘çš„æµç¨‹ï¼Œå¹¶é€šè¿‡æ ‡å‡†åŒ–çš„ä¹¦å†™æ¥è§„èŒƒæ ¼å¼ã€‚æ„Ÿè°¢ç½—è€å¸ˆçš„è€å¿ƒæŒ‡å¯¼å’Œå¸®åŠ©ï¼Œåœ¨å®é™…æ¯•è®¾çš„å†™ä½œè¿‡ç¨‹ä¸­ï¼Œå…³æ³¨ç€æˆ‘ä»¬çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚  
>  åŒæ—¶éœ€è¦æ„Ÿè°¢å…¬å¸[Andawell](http://www.andawell.com/)çš„æ”¯æŒï¼Œèƒ½ä¸ºæˆ‘æä¾›åœ¨å…¬å¸è¾¹å®ä¹ è¾¹åšæ¯•è®¾çš„æœºä¼šã€‚åŒæ—¶èƒ½å°†æ¯•è®¾ä¸é¡¹ç›®å¼€å‘çš„æ ‡å‡†æ›´å¥½åœ°ç»“åˆã€‚  
>  æœ€åè¿˜éœ€è¦é¼“åŠ±è‡ªå·±ï¼Œå› ä¸ºéœ€è¦ä»˜å‡ºå¾ˆå¤šçš„åŠªåŠ›ã€‚

# æ­£æ–‡

---

ä¸€æ–¹é¢ä¸»è¦æ˜¯æŠ€æœ¯ä¸Šçš„è¦æ±‚ï¼Œä¸€æ–¹é¢ä¸»è¦æ˜¯è®ºæ–‡ä¸Šçš„æ’ç‰ˆã€‚ç„¶åå¸Œæœ›æˆ‘é‡åˆ°çš„é—®é¢˜ï¼Œä¹Ÿèƒ½å¸®åˆ°å¤§å®¶ã€‚

## **word ä¸­ mathtype å…¬å¼åä¸Šæµ®æˆ–åä¸‹æ²‰æ€ä¹ˆåŠ**

---

åˆšæ‰é‡åˆ°äº†å…¬å¼ä¸Šæµ®çš„é—®é¢˜ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ amath è¿›è¡Œå…¬å¼çš„ç¼–å†™ï¼Œæ­é…å›¾ç‰‡è½¬ latex è¿›è¡Œè°ƒæ•´ã€‚ç„¶åæ‰¾åˆ°äº†è¿™ä¸ªé—®é¢˜çš„è§£å†³åŠæ³•ã€‚æ„Ÿè°¢ whu æ•°ç å›æä¾›çš„[å›ç­”](https://jingyan.baidu.com/article/09ea3edef9845480aede39a5.html)ã€‚

## å¦‚ä½•ä½¿ç”¨å›¾ç‰‡è½¬ latex

---

ä¹‹å‰æœ‰åŒå­¦é—®è¿‡æˆ‘è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»Šå¤©ä¹Ÿå†ä¸€æ¬¡é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œçœ‹åˆ°è®ºæ–‡ä¸­å¤æ‚çš„å…¬å¼ï¼Œä¸€ç­¹è«å±•æ€ä¹ˆåŠï¼Œå¯ä»¥é€šè¿‡å›¾ç‰‡è½¬ latex çš„æ–¹å¼ï¼Œè¿™æ˜¯æˆ‘æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œä½†æ˜¯ç°åœ¨ä¸»æµçš„è½¬ latex çš„å¥½çš„è½¯ä»¶ä¸å¤šï¼Œåœ¨æ­¤ç‰¹åˆ«æ„Ÿè°¢[simpletex](https://simpletex.cn/ai/latex_ocr)æä¾›çš„æ”¯æŒã€‚

## å…³äºè¯­ç—…çš„ä¿®æ”¹

---

æ„Ÿè°¢ up ä¸»ï¼š[ç”¨é•œå¤´è®°å½•æˆé•¿](https://space.bilibili.com/26021795)ï¼Œå‚è€ƒ[è®ºæ–‡å†™ä½œè¡¨è¾¾è¯­å¥è¡¨è¾¾ç³»åˆ—è¯¾ç¨‹ ä¸€ ç—…å¥ä¿®æ”¹ æˆåˆ†æ®‹ç¼º\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1PB4y1U7JU/?buvid=XYA9A96A2DBF2E51A918ECE55EFA494C98935&is_story_h5=false&mid=nPIoZdTfuXw2Qtcat9xxZw%3D%3D&p=1&plat_id=114&share_from=ugc&share_medium=android&share_plat=android&share_session_id=e1117509-5d59-4fd0-b122-21d23e500899&share_source=WEIXIN&share_tag=s_i&timestamp=1693714483&unique_k=HFqrbnI&up_id=26021795&share_times=1&vd_source=237e295a40d7aaea043ead8c0d2c78ab)è¯¥è§†é¢‘è¿›è¡Œæ€»ç»“ã€‚

<details>
  <summary>ä»¥ä¸‹å†…å®¹æ˜¯å¯¹è¯¥è§†é¢‘è¿›è¡Œçš„ç¬”è®°æ¢³ç†ã€‚</summary>

### ä¸€ã€ä¸»è¯­æ®‹ç¼º

---

- **æ»¥ç”¨ä»‹è¯**

> ä»è¿™ä»¶å°äº‹ï¼Œè¯´æ˜ä¸€ä¸ªé“ç†

åº”æ”¹ä¸ºï¼Œè¿™ä»¶å°äº‹è¯´æ˜ä¸€ä¸ªé“ç†ã€‚ä¸Šè¿°ä¾‹å­ä¸­ç¼ºå°‘ä¸»è¯­ã€‚

> å½“å­¦ç”Ÿäº†è§£äº†ç¾æ˜¯ä»€ä¹ˆï¼Œå°±ä¼šä»¥ç¾çš„æ ‡å‡†ç±³è§„èŒƒè‡ªå·±çš„è¡Œä¸ºå’Œæ€æƒ³ã€‚

åº”å»é™¤â€œå½“â€å­—ã€‚

- **æ»¥ç”¨ä½¿ä»¤åŠ¨è¯**

> é€šè¿‡è¿™ä»¶å°äº‹ï¼Œä½¿æˆ‘æ˜ç™½äº†ä¸€ä¸ªé“ç†ã€‚

å»é™¤â€é€šè¿‡â€œäºŒå­—ã€‚

> é€šè¿‡å¯¹è¯¥è¯¾é¢˜çš„ç ”ç©¶ï¼Œå¾—å‡ºæ–°æ—¶ä»£ç²¾ç¥çš„å«ä¹‰ã€‚

éœ€æ·»åŠ ä¸»è¯­ï¼Œä¾‹å¦‚â€œç¬”è€…å¾—å‡ºâ€¦â€¦â€**(å¦å¤–è¿˜éœ€è¦å°½é‡é¿å…åœ¨è®ºæ–‡ä¸­ä½¿ç”¨â€œæˆ‘â€å­—)**

- **åæ­£çŸ­è¯­ç¼ºä¸­å¿ƒè¯­**

> è¯¾å ‚æ•™å­¦ä½æ•ˆï¼Œä¸€ç›´æœªå¾—åˆ°è§£å†³ã€‚

éœ€åœ¨â€ä½æ•ˆâ€œåé¢åŠ ä¸Šâ€çš„é—®é¢˜â€œ

> æˆ‘å¯¹ç»æµä¸ç”Ÿæ´»è¿™æœ¬æ•™ææ„Ÿåˆ°å›°æ„Ÿã€‚

éœ€åœ¨â€œæ•™æâ€åé¢åŠ ä¸Šâ€œçš„å†…å®¹â€

- **æ»¥ç”¨çœç•¥**

> åœ¨ç»å†äº†å‡ åƒå¹´çš„å°å»ºç»Ÿæ²»åï¼Œäººä»¬åˆå¼€å§‹é‡è§†è¢«ç¦é”¯çš„å¤å…¸æ–‡åŒ–ï¼Œå¹¶æˆä¸ºäººæ–‡ä¸»ä¹‰è€…çš„æ­¦å™¨ï¼Œç”¨ç±³åå¯¹ç¥æƒã€‚

åº”æ”¹ä¸ºâ€å¤å…¸æ–‡åŒ–å¹¶æˆä¸ºäººæ–‡ä¸»ä¹‰è€…çš„æ­¦å™¨â€œ

- **åŠ©è¯ç”¨é”™**

> 2022 å¹´é¢å¸ƒäº†ã€Šå®¶åº­æ•™è‚²æŒ‡å¯¼æ³•ã€‹ï¼Œæ˜¯æˆ‘å›½é¦–éƒ¨å®¶åº­æ•™è‚²æ³•ã€‚

æŠŠâ€œäº†â€æ”¹æˆâ€œçš„â€

### äºŒã€è°“è¯­æ®‹ç¼º

---

- **å¥é¦–ç¼ºè°“å¦èµ·å¤´**

> ç»è¿‡å‡ åå¹´çš„åŠªåŠ›ï¼Œæˆ‘å›½å·±ç»ç‹¬ç«‹è‡ªä¸»åœ°ç ”åˆ¶ã€å‘å°„ã€è·Ÿè¸ªå’Œæµ‹æ£€åœ°çƒåŒæ­¥é€šè®¯å«æ˜Ÿçš„èƒ½åŠ›ã€‚

å…·å¤‡â€¦â€¦çš„èƒ½åŠ›

> æŸå¤§å­¦å·¥å•†ç®¡ç†å­¦é™¢åœ¨è¯¾ç¨‹è®¾ç½®ä¸Šé™¤äº†ä¸“ä¸šè¯¾ã€å¤–è¯­è¯¾ã€æ”¿æ²»ç†è®ºè¯¾ï¼Œè¿˜åŒ…æ‹¬æ¼”è®²ä¸å£æ‰ã€åŸºç¡€å†™ä½œç­‰è¯¾ç¨‹ï¼Œä»¥è¿›ä¸€æ­¥æé«˜è¯´å†™æ–¹é¢çš„æŠ€èƒ½ã€‚

é™¤äº†è®¾ç½®æœ‰â€¦â€¦ **(ç¬¬ä¸€å¥è¯ç¼ºå°‘è°“è¯­)**

- **åŠ¨å®¾ç¼ºåŠ¨**

> æˆ‘å¸‚æœ€è¿‘å‘åŠ¨äº†å…¨é¢çš„è´¨é‡å¤§æ£€æŸ¥è¿åŠ¨ï¼Œè¦åœ¨è¿™ä¸ªè¿åŠ¨ä¸­å»ºç«‹ä¸åŠ å¼ºæŠ€æœ¯ç®¡ç†åˆ¶åº¦ç­‰ä¸€ç³»åˆ—å·¥ä½œã€‚

è¦åœ¨è¿™ä¸ªè¿åŠ¨ä¸­**å®Œæˆ**å»ºç«‹ä¸åŠ å¼ºæŠ€æœ¯ç®¡ç†åˆ¶åº¦ç­‰ä¸€ç³»åˆ—**å·¥ä½œ**

> æ”¿åºœå¿…é¡»ä¸¥å‰æ‰“å‡»é£Ÿå“å®‰å…¨è¿æ³•è¿è§„è¡Œä¸ºçš„é«˜å‹æ€åŠ¿ï¼ŒåŠæ—¶æ¶ˆé™¤å„ç¯èŠ‚é¢†åŸŸçš„éšæ‚£ï¼Œåˆ›æ–°é£Ÿå“å®‰å…¨ç›‘ç®¡æƒ©å¤„ä½“åˆ¶æœºåˆ¶ã€‚

ä¿æŒä¸¥å‰æ‰“å‡»â€¦

> æ•™å¸ˆåœ¨æ³•å¾‹ä¸“ä¸šçŸ¥è¯†å’Œé€»è¾‘æ€ç»´èƒ½åŠ›æå‡æ–¹é¢é¢ä¸´å›°éš¾ã€‚

æ•™å¸ˆåœ¨æ³•å¾‹ä¸“ä¸šçŸ¥è¯†æ‹“å±•â€¦ (çŸ¥è¯†å’Œæå‡æ­é…ä¸æ˜¯éå¸¸å¥½ï¼Œæ­é…çŸ¥è¯†æ‹“å±•å¯èƒ½ä¼šæ›´å¥½)

### ä¸‰ã€å®¾è¯­æ®‹ç¼º

---

- **åŠ¨å®¾ç¼ºå®¾**

> å­¦æ ¡å®¿èˆã€æ•™å­¦æ¥¼ç­‰äººç¾¤å¯†é›†åŒºï¼Œä¸€ä¸”å‘ç”Ÿç«ç¾ï¼Œåæœä¸å ªè®¾æƒ³ï¼Œå› æ­¤å­¦ç”ŸæŒæ¡ç«ç¾ä¸­è‡ªæ•‘äº’æ•™ç›¸å½“é‡è¦ã€‚

æŒæ¡â€¦æŠ€èƒ½

- **ä»‹å®¾ç¼ºå®¾**

> è¿™éƒ¨ç”µå½±åœ¨å¡‘é€ äººç‰©å½¢è±¡æ‰€æä¾›çš„ç»éªŒæ˜¯éå¸¸å®è´µçš„ï¼Œ

åœ¨â€¦æ–¹é¢

- **è¯¯å°†å®šè¯­å½“å®¾è¯­**

> æ¡ƒèŠ±ä¹¡èµ°å¯æŒç»­å‘å±•ä¹‹è·¯ï¼ŒæŒ‰ç…§å»ºæˆç”Ÿæ€ç¯å¢ƒå’Œè°ä¼˜ç¾ã€èµ„æºé›†çº¦èŠ‚çº¦åˆ©ç”¨ã€ç»æµå’Œç¤¾ä¼šåè°ƒå‘å±•çš„ç”Ÿæ€ä¹¡ï¼Œåˆ¶å®šäº†äº”å¹´å‘å±•å»ºè®¾è§„åˆ’ã€‚

æŒ‰ç…§â€¦ç›®æ ‡ï¼Œè§„åˆ’

### å››ã€è™šè¯æ®‹ç¼º

---

- **ä»‹å®¾ç¼ºä»‹**

> 2014 å¹´åº•ï¼Œæˆ‘å›½æ¢æœˆå·¥ç¨‹ä¸‰æœŸâ€œå†å…¥è¿”å›é£è¡Œâ€è¯•éªŒè·å¾—æˆåŠŸï¼Œç¡®ä¿å«¦å¨¥äº”å·ä»»åŠ¡é¡ºåˆ©å®æ–½å’Œæ¢æœˆå·¥ç¨‹æŒç»­æ¨è¿›è«å®šåšå®åŸºç¡€ï¼Œ

ä¸ºâ€¦å¥ å®šåšå®åŸºç¡€

- **è¢«åŠ¨ç¼ºè¢«**

> è¿™æœ¬ä¹¦éå¸¸æœ‰ä»·å€¼ï¼Œå¸¸å¸¸å›¾ä¹¦é¦†æ”¶è—ã€‚

å¸¸å¸¸è¢«å›¾ä¹¦é¦†æ”¶è—

- **å¯¹è±¡ç¼ºå¯¹**

> ç°ä»£å¥³æ€§è¶Šæ¥è¶Šç‹¬ç«‹ï¼Œå¥¹ä»¬é™¤äº†è‡ªå·±ç‹¬ç«‹æŒ£é’±å¤–ï¼Œå¯¹è‡ªèº«çš„ä»·å€¼ã€ç”Ÿæ´»ç¯å¢ƒä¹Ÿè¶Šå‘é‡è§†ï¼Œé‚£äº›ä»·å€¼å‰¥å‰Šã€æ€§éªšæ‰°ï¼Œå¥¹ä»¬å°†è¯´ä¸ã€‚

å¯¹é‚£äº›ä»·å€¼å‰¥å‰Šã€æ€§éªšæ‰°ï¼Œå¥¹ä»¬å°†è¯´ä¸ã€‚

  </details>

## æ­å»º yolov5 ç¯å¢ƒ

---

è¯¦ç»†å‚ç…§ up ä¸»ï¼š[**æ€ç»ªäº¦æ— é™**](https://space.bilibili.com/456667721)çš„ä»‹ç»ï¼š

[**Win11 ä¸­ä»å¤´å®‰è£…è½¯ä»¶å’Œé…ç½®ç¯å¢ƒè¿è¡Œæ·±åº¦å­¦ä¹ é¡¹ç›®**](https://www.bilibili.com/video/BV1Hg4y1t78v/?spm_id_from=333.999.0.0&vd_source=237e295a40d7aaea043ead8c0d2c78ab)

ç„¶åæœ€ä¸»è¦çš„è¿˜éœ€è¦å¼•å…¥è‹±ä¼Ÿè¾¾çš„ CUDAï¼Œå¯ä»¥ç°åœ¨æœ¬åœ°è£…ï¼Œä½†æˆ‘è¿˜æ˜¯å€¾å‘äºé€‰æ‹©[autodl](https://www.autodl.com/home)ï¼Œå› ä¸ºè¿™é‡Œå·²ç»é¢„è£…äº† cuda ç¯å¢ƒã€‚

è¿™é‡Œç»†èŠ‚å¾ˆå¤šï¼Œä½†ç°åœ¨åˆè¿‡äº†å¥½ä¹…äº†ï¼Œ**æœ‰ç‚¹å¿˜äº†**ï¼Œåœ¨é€‰æ‹©åŸºç¡€é•œåƒçš„æ—¶å€™å°±åº”è¯¥è¦æ³¨æ„é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼Œä¸ç„¶åé¢é…ç½® cuda ä¼šéº»çƒ¦æ­»ã€‚ï¼ˆçœ‹æ¥æ—¥å¿—è¿˜æ˜¯è¦åŠæ—¶è®°å½•ï¼Œå½“æ—¶è´¹äº†ä¸€ä¸‹åˆçš„åŠ²ï¼ŒçœŸæ˜¯æœäº†ï¼‰

## æ•°æ®é›†çš„é¢„å¤„ç†

---

è¯¾é¢˜ä¸­ yolov5 çš„æ•°æ®é›†æ˜¯é‡‡ç”¨çš„èˆªæ‹è§†è§’ï¼Œåœ¨è‚‰çœ¼è¯†åˆ«å­˜åœ¨å›°éš¾ï¼Œè¿˜æœ‰å¾ˆå¤šå¹²æ‰°ã€‚æ‰€ä»¥éœ€è¦é¢„å…ˆå¯¹æ•°æ®é›†è¿›è¡Œåˆ‡ç‰‡å¤„ç†ã€‚ç„¶åæŒ‘å‡ºåˆ‡ç‰‡å®ŒååŒ…å«é»‘åŒ£å­çš„å›¾ç‰‡ï¼Œå†è¿›è¡Œæ ‡æ³¨ã€‚

ä»¥ä¸‹æ˜¯åˆ‡ç‰‡ç¨‹åºï¼š

```python
from PIL import Image
import os
import random
#from PIL import Image: å¯¼å…¥Python Imaging Library (PIL) ä¸­çš„ Image æ¨¡å—ï¼Œç”¨äºå›¾åƒå¤„ç†ã€‚
#import os: å¯¼å…¥ os æ¨¡å—ï¼Œç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•ã€‚
#import random: å¯¼å…¥ random æ¨¡å—ï¼Œç”¨äºç”Ÿæˆéšæœºæ•°ã€‚

def slice_and_save_images(input_folder, output_folder, random_size=True, fixed_size=(640, 640), overlap_ratio=0.2):
    #å‡½æ•°çš„å®šä¹‰ï¼Œå®ƒæ¥æ”¶å‡ ä¸ªå‚æ•°ï¼ŒåŒ…æ‹¬è¾“å…¥è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ã€æ˜¯å¦éšæœºåˆ‡ç‰‡å¤§å°ã€å›ºå®šåˆ‡ç‰‡å¤§å°ä»¥åŠé‡å æ¯”ç‡ã€‚
    # è·å–è¾“å…¥æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
    image_files = [f for f in os.listdir(input_folder) if f.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp'))]

    # åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹
    os.makedirs(output_folder, exist_ok=True)

    # å¾ªç¯å¤„ç†æ¯å¼ å›¾åƒ
    for image_file in image_files:
        input_path = os.path.join(input_folder, image_file)

        # æ‰“å¼€å›¾åƒ
        original_image = Image.open(input_path)

        # è·å–å›¾åƒå¤§å°
        width, height = original_image.size

        # éšæœºç”Ÿæˆæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ‡ç‰‡å¤§å°
        #æ ¹æ® random_size å‚æ•°å†³å®šæ˜¯éšæœºç”Ÿæˆåˆ‡ç‰‡å¤§å°è¿˜æ˜¯ä½¿ç”¨å›ºå®šå¤§å°ã€‚éšæœºå¤§å°åœ¨å›ºå®šå¤§å°çš„ä¸€åŠåˆ°å›ºå®šå¤§å°ä¹‹é—´ã€‚
        if random_size:
            slice_width = random.randint(fixed_size[0] // 2, fixed_size[0])
            slice_height = random.randint(fixed_size[1] // 2, fixed_size[1])
        else:
            slice_width, slice_height = fixed_size

        # è®¡ç®—é‡å åŒºåŸŸå¤§å°,ç”± overlap_ratio å‚æ•°å†³å®šçš„ã€‚
        overlap_width = int(slice_width * overlap_ratio)
        overlap_height = int(slice_height * overlap_ratio)

        # è®¡ç®—åˆ‡ç‰‡æ•°é‡
        num_slices_horizontal = (width - overlap_width) // (slice_width - overlap_width)
        num_slices_vertical = (height - overlap_height) // (slice_height - overlap_height)

        # åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨äºä¿å­˜åˆ‡ç‰‡åçš„å°å›¾ç‰‡
        output_subfolder = os.path.join(output_folder, os.path.splitext(image_file)[0])
        os.makedirs(output_subfolder, exist_ok=True)

        # åˆ‡ç‰‡å¹¶ä¿å­˜
        for i in range(num_slices_horizontal):
            for j in range(num_slices_vertical):
                left = i * (slice_width - overlap_width)
                upper = j * (slice_height - overlap_height)
                right = left + slice_width
                lower = upper + slice_height

                # åˆ‡ç‰‡
                slice_image = original_image.crop((left, upper, right, lower))

                # ç”Ÿæˆå”¯ä¸€çš„åˆ‡ç‰‡æ–‡ä»¶å
                slice_filename = f"{os.path.splitext(image_file)[0]}_slice_{j}_{i}.jpg"

                # ä¿å­˜åˆ‡ç‰‡
                slice_image.save(os.path.join(output_subfolder, slice_filename))

# è°ƒç”¨å‡½æ•°ï¼Œä¼ å…¥è¾“å…¥å›¾åƒæ–‡ä»¶å¤¹è·¯å¾„å’Œè¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„,æ›´æ¢ä¸ºè‡ªå·±çš„æ–‡ä»¶å¤¹
slice_and_save_images(r"C:\Users\Raj\Desktop\bbox", r"C:\Users\Raj\Desktop\bboxå…¨éƒ¨åˆ‡ç‰‡",
                      random_size=False, fixed_size=(640, 640))
```

åˆ‡ç‰‡å®Œæˆä¹‹åï¼Œéœ€è¦æŒ‘å‡ºåŒ…å«åˆ‡ç‰‡ä¸­åŒ…å«ç›®æ ‡å¯¹è±¡çš„å›¾ç‰‡ï¼Œä¹‹åä½œä¸ºè®­ç»ƒé›†ã€‚

![](https://bu.dusays.com/2024/04/11/6617967763c57.webp)

## éªŒè¯é›†

---

æœ€å¼€å§‹éªŒè¯é›†æ˜¯ç”¨çš„æ•°æ®é›†çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯åé¢é‡‡ç”¨æ–°çš„éªŒè¯é›†ï¼Œéš¾åº¦ç¬é—´å°±ä¸Šæ¥äº†ï¼Œæµ‹è¯•ç²¾åº¦ä» 0.996 ç¬é—´è·Œåˆ°éƒ½åˆ°ä¸äº† 0.7ã€‚ä¸€æ–¹é¢éœ€è¦æ‰©å……æ•°æ®é›†ï¼Œå¦ä¸€æ–¹é¢éœ€è¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹å¯¹ç½‘ç»œå‚æ•°è¿›è¡Œè°ƒæ•´ã€‚

![](https://bu.dusays.com/2024/04/11/66179754ea383.webp)

## æ‰©å……è®­ç»ƒé›†

---

æ„Ÿè°¢ CSDN åšä¸»ï¼š[**æˆ‘è¦å˜èƒ–å“‡**](https://blog.csdn.net/qq_44421796)**ã€**[**è·¯äººè´¾'Ï‰'**](https://blog.csdn.net/weixin_43334693)

å‚è€ƒæ–‡ç« ï¼š[**YOLO æ•°æ®é›†å®ç°æ•°æ®å¢å¼ºçš„æ–¹æ³•ï¼ˆè£å‰ªã€å¹³ç§» ã€æ—‹è½¬ã€æ”¹å˜äº®åº¦ã€åŠ å™ªå£°ç­‰ï¼‰**](https://blog.csdn.net/weixin_43334693/article/details/131744918)

### æ•°æ®å¢å¼ºçš„æ¦‚å¿µå’Œä½œç”¨

---

**æ•°æ®å¢å¼º**æ˜¯ä¸€ç§é‡è¦çš„æœºå™¨å­¦ä¹ æ–¹æ³•ä¹‹ä¸€ï¼Œæ˜¯**åŸºäºå·²æœ‰çš„è®­ç»ƒæ ·æœ¬æ•°æ®æ¥ç”Ÿæˆæ›´å¤šçš„è®­ç»ƒæ•°æ®**ï¼Œå…¶ç›®çš„å°±æ˜¯**ä¸ºäº†ä½¿æ‰©å¢çš„è®­ç»ƒæ•°æ®å°½å¯èƒ½æ¥è¿‘çœŸå®åˆ†å¸ƒçš„æ•°æ®ï¼Œä»è€Œæé«˜æ£€æµ‹ç²¾åº¦**ã€‚æ­¤å¤–ï¼Œæ•°æ®å¢å¼ºèƒ½å¤Ÿè¿«ä½¿æ¨¡å‹**å­¦ä¹ åˆ°æ›´å¤šé²æ£’æ€§çš„ç‰¹å¾ï¼Œä»è€Œæœ‰æ•ˆæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›**ã€‚

### å¸¸è§çš„æ•°æ®å¢å¼ºçš„åŠæ³•

---

ï¼ˆ1ï¼‰æ¯”è¾ƒå¸¸ç”¨çš„**å‡ ä½•å˜æ¢**æ–¹æ³•ä¸»è¦æœ‰ï¼š
ç¿»è½¬ã€æ—‹è½¬ã€è£å‰ªã€ç¼©æ”¾ã€å¹³ç§»ã€æŠ–åŠ¨
ï¼ˆ2ï¼‰æ¯”è¾ƒå¸¸ç”¨çš„**åƒç´ å˜æ¢**æ–¹æ³•ä¸»è¦æœ‰ï¼š
åŠ æ¤’ç›å™ªå£°ã€é«˜æ–¯å™ªå£°ã€è¿›è¡Œé«˜æ–¯æ¨¡ç³Šã€è°ƒæ•´ HSV å¯¹æ¯”åº¦ã€è°ƒèŠ‚äº®åº¦ã€é¥±å’Œåº¦ã€ç›´æ–¹å›¾å‡è¡¡åŒ–ã€è°ƒæ•´ç™½å¹³è¡¡ç­‰

å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š

- éšæœºè£å‰ªï¼šä»åŸå§‹å›¾åƒä¸­éšæœºè£å‰ªå‡ºä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚è£å‰ªå››è§’ã€ä¸­å¿ƒæˆ–è€…ä¸Šä¸‹éƒ¨åˆ†ç­‰ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿå¢åŠ æ¨¡å‹çš„é²æ£’æ€§ï¼Œä½¿å…¶å¯¹å›¾åƒçš„ä¸åŒéƒ¨åˆ†éƒ½èƒ½è¿›è¡Œæœ‰æ•ˆçš„ç‰¹å¾æå–ã€‚
- ç¿»è½¬æˆ–é•œåƒï¼šå¯ä»¥æ°´å¹³ç¿»è½¬æˆ–å‚ç›´ç¿»è½¬å›¾åƒã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ¨¡æ‹Ÿå›¾åƒåœ¨ä¸åŒè§†è§’ä¸‹çš„æƒ…å†µï¼Œå¸®åŠ©æ¨¡å‹å­¦ä¹ åˆ°æ›´å¤šçš„ç‰¹å¾ã€‚
- æ—‹è½¬ï¼šå°†åŸå›¾åƒæ—‹è½¬ä¸åŒçš„è§’åº¦æ¥ç”Ÿæˆæ–°çš„æ ·æœ¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ—‹è½¬åå›¾åƒçš„ç»´åº¦å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤åœ¨å¤„ç†æ—¶éœ€è¦ç¡®ä¿å›¾åƒå°ºå¯¸çš„åˆç†æ€§ã€‚
- äº®åº¦æˆ–å¯¹æ¯”åº¦è°ƒèŠ‚ï¼šé€šè¿‡æ”¹å˜å›¾åƒçš„äº®åº¦å’Œå¯¹æ¯”åº¦ï¼Œå¯ä»¥æ¨¡æ‹Ÿä¸åŒå…‰ç…§æ¡ä»¶ä¸‹çš„å›¾åƒæƒ…å†µï¼Œæé«˜æ¨¡å‹çš„é€‚åº”æ€§ã€‚
- è‰²åº¦è°ƒèŠ‚ï¼šæ”¹å˜å›¾åƒä¸­ Rã€Gã€B é¢œè‰²åˆ†é‡çš„æ¯”ä¾‹ï¼Œä»è€Œç”Ÿæˆå…·æœ‰ä¸åŒé¢œè‰²ç‰¹å¾çš„æ ·æœ¬ã€‚
  é¥±å’Œåº¦è°ƒèŠ‚ï¼šè°ƒèŠ‚å›¾åƒçš„é¥±å’Œåº¦ï¼Œå³æ”¹å˜è‰²å½©çš„çº¯åº¦ã€‚è¿™å¯ä»¥æ¨¡æ‹Ÿä¸åŒé¢œè‰²é²œè‰³ç¨‹åº¦çš„å›¾åƒï¼Œå¢åŠ æ ·æœ¬çš„å¤šæ ·æ€§ã€‚
- é«˜æ–¯æ¨¡ç³Šã€é”åŒ–ã€æ·»åŠ å™ªå£°ï¼šå¯¹å›¾åƒè¿›è¡Œè¿™äº›å¤„ç†å¯ä»¥æ¨¡æ‹Ÿå›¾åƒåœ¨é‡‡é›†å’Œä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„å¤±çœŸæƒ…å†µï¼Œæœ‰åŠ©äºæé«˜æ¨¡å‹çš„é²æ£’æ€§ã€‚
  ç°åº¦åŒ–ï¼šå°†å½©è‰²å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒï¼Œå¯ä»¥è¿›ä¸€æ­¥å¢åŠ æ ·æœ¬çš„å¤šæ ·æ€§

### txt è½¬ xml

---

åœ¨æ•°æ®å¢å¼ºçš„æ—¶å€™ï¼Œä»£ç æ˜¯å¯¹ xml è¿›è¡Œæ“ä½œçš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆç»å†ä¸€æ­¥ï¼Œä» txt åˆ° xml çš„è¿‡ç¨‹ã€‚

**æ ¸å¿ƒåŸç†è§£é‡Š**ï¼šå°† YOLO æ ¼å¼ä¸­çš„å½’ä¸€åŒ–åæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡ã€‚

1. ä» YOLO æ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–æ¯ä¸ªç›®æ ‡çš„ç±»åˆ«ç´¢å¼•å’Œå½’ä¸€åŒ–çš„è¾¹ç•Œæ¡†åæ ‡ Â `(class_index, x_center_norm, y_center_norm, width_norm, height_norm)`ã€‚
2. å°†å½’ä¸€åŒ–çš„ä¸­å¿ƒç‚¹åæ ‡ Â `(x_center_norm, y_center_norm)`Â  å’Œå®½åº¦ã€é«˜åº¦ Â `(width_norm, height_norm)`Â  è½¬æ¢ä¸ºåƒç´ åæ ‡ã€‚
3. ä½¿ç”¨åƒç´ åæ ‡æ¥è®¡ç®— PASCAL VOC æ ¼å¼çš„è¾¹ç•Œæ¡† Â `(xmin, ymin, xmax, ymax)`

**æ ¸å¿ƒè½¬æ¢é€»è¾‘ï¼š**

```python
# è®¡ç®— PASCAL VOC çš„ (xmin, ymin, xmax, ymax)
xmin = int(round(x_center - (width / 2)))
ymin = int(round(y_center - (height / 2)))
xmax = int(round(x_center + (width / 2)))
ymax = int(round(y_center + (height / 2)))
```

**è½¬æ¢ä»£ç ï¼š**

```python
# -*- coding: utf-8 -*-
import os
import cv2
from lxml.etree import Element, SubElement, tostring


def txt_xml(img_path, img_name, txt_path, img_txt, xml_path, img_xml):
    clas = []
    # è¯»å–txtçš„ä¿¡æ¯
    txt_img = os.path.join(txt_path, img_txt)

    # å›¾åƒçš„å®½åº¦å’Œé«˜åº¦
    imw = 640  # åº”å½“æ ¹æ®å®é™…å›¾ç‰‡å¤§å°è¿›è¡Œè°ƒæ•´
    imh = 640  # åº”å½“æ ¹æ®å®é™…å›¾ç‰‡å¤§å°è¿›è¡Œè°ƒæ•´

    with open(txt_img, "r") as f:
        for line in f.readlines():
            line = line.strip('\n')
            list = line.split(" ")
            print(list)
            clas.append(list)

    # åˆ›å»ºXMLæ–‡æ¡£çš„æ ¹èŠ‚ç‚¹å’Œç›¸å…³å­èŠ‚ç‚¹
        # åˆ›å»ºXMLæ–‡æ¡£çš„æ ¹èŠ‚ç‚¹
        node_root = Element('annotation')
        node_folder = SubElement(node_root, 'folder')
        node_folder.text = '1'
        node_filename = SubElement(node_root, 'filename')

        # å›¾åƒåç§°
        node_filename.text = img_name
        node_size = SubElement(node_root, 'size')
        node_width = SubElement(node_size, 'width')
        node_width.text = str(imw)
        node_height = SubElement(node_size, 'height')
        node_height.text = str(imh)
        node_depth = SubElement(node_size, 'depth')
        node_depth.text = '3'

    # éå†æ‰€æœ‰çš„æ ‡æ³¨ä¿¡æ¯å¹¶æ·»åŠ åˆ°XMLä¸­
        # éå†æ‰€æœ‰çš„æ ‡æ³¨ä¿¡æ¯
        for i in range(len(clas)):
            x_center_norm = float(clas[i][1])
            y_center_norm = float(clas[i][2])
            width_norm = float(clas[i][3])
            height_norm = float(clas[i][4])
            # è½¬æ¢å½’ä¸€åŒ–åæ ‡åˆ°åƒç´ åæ ‡
            x_center = x_center_norm * imw
            y_center = y_center_norm * imh
            width = width_norm * imw
            height = height_norm * imh
            # è®¡ç®—å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            xmin = str(int(round(x_center - (width / 2))))
            ymin = str(int(round(y_center - (height / 2))))
            xmax = str(int(round(x_center + (width / 2))))
            ymax = str(int(round(y_center + (height / 2))))

            # åˆ›å»ºXMLèŠ‚ç‚¹å¹¶èµ‹å€¼
            node_object = SubElement(node_root, 'object')
            node_name = SubElement(node_object, 'name')
            node_name.text = str(clas[i][0])
            node_pose = SubElement(node_object, 'pose')
            node_pose.text = "Unspecified"
            node_truncated = SubElement(node_object, 'truncated')
            node_truncated.text = "0"
            node_difficult = SubElement(node_object, 'difficult')
            node_difficult.text = '0'
            node_bndbox = SubElement(node_object, 'bndbox')
            node_xmin = SubElement(node_bndbox, 'xmin')
            node_xmin.text = xmin
            node_ymin = SubElement(node_bndbox, 'ymin')
            node_ymin.text = ymin
            node_xmax = SubElement(node_bndbox, 'xmax')
            node_xmax.text = xmax
            node_ymax = SubElement(node_bndbox, 'ymax')
            node_ymax.text = ymax

    # å°†XMLå†…å®¹å†™å…¥æ–‡ä»¶
    xml = tostring(node_root, pretty_print=True)
    img_newxml = os.path.join(xml_path, img_xml)
    with open(img_newxml, 'wb') as file_object:
        file_object.write(xml)


if __name__ == "__main__":
    # å›¾åƒã€æ ‡æ³¨å’ŒXMLæ–‡ä»¶å¤¹æ‰€åœ¨ä½ç½®ã€æ›´æ¢è‡ªå·±çš„ç»å¯¹è·¯å¾„
    img_path = r"D:\@Graduation\enhance\data\images\train"
    txt_path = r"D:\@Graduation\enhance\data\labels\train"
    xml_path = r"D:\@Graduation\enhance\data\labels\xml"
    for img_name in os.listdir(img_path):
        img_base_name = os.path.splitext(img_name)[0]
        img_xml = img_base_name + ".xml"
        img_txt = img_base_name + ".txt"
        txt_xml(img_path, img_name, txt_path, img_txt, xml_path, img_xml)
```

ä¾‹å¦‚ï¼Œè¿™å°±æ˜¯æ ‡æ³¨åçš„å½’ä¸€åŒ–åæ ‡

```text
0 0.719594 0.901037 0.108083 0.091896
```

è¿™å°±æ˜¯è½¬æ¢åçš„ xml åæ ‡å’Œå…¶ä»–çš„ä¸€äº›å…ƒç´ ï¼Œè½¬æ¢å®Œå¯ä»¥ç”¨ labelimg éªŒè¯ä¸€ä¸‹

```html
<annotation>
  <folder>1</folder>
  <filename>000000_slice_2_2.jpg</filename>
  <size>
    <width>640</width>
    <height>640</height>
    <depth>3</depth>
  </size>
  <object>
    <name>0</name>
    <pose>Unspecified</pose>
    <truncated>0</truncated>
    <difficult>0</difficult>
    <bndbox>
      <xmin>426</xmin>
      <ymin>547</ymin>
      <xmax>495</xmax>
      <ymax>606</ymax>
    </bndbox>
  </object>
</annotation>
```

### æ•°æ®é›†æ‰©å……

---

æ ¹æ®ä¸Šè¿°åˆ†æçš„æ–¹å¼è¿›è¡Œæ•°æ®é›†æ‰©å……

```python
# -*- coding=utf-8 -*-

import time
import random
import copy
import cv2
import os
import math
import numpy as np
from skimage.util import random_noise
from lxml import etree, objectify
import xml.etree.ElementTree as ET
import argparse


# æ˜¾ç¤ºå›¾ç‰‡
def show_pic(img, bboxes=None):
    '''
    è¾“å…¥:
        img:å›¾åƒarray
        bboxes:å›¾åƒçš„æ‰€æœ‰boudning box list, æ ¼å¼ä¸º[[x_min, y_min, x_max, y_max]....]
        names:æ¯ä¸ªboxå¯¹åº”çš„åç§°
    '''
    for i in range(len(bboxes)):
        bbox = bboxes[i]
        x_min = bbox[0]
        y_min = bbox[1]
        x_max = bbox[2]
        y_max = bbox[3]
        cv2.rectangle(img, (int(x_min), int(y_min)), (int(x_max), int(y_max)), (0, 255, 0), 3)
    cv2.namedWindow('pic', 0)  # 1è¡¨ç¤ºåŸå›¾
    cv2.moveWindow('pic', 0, 0)
    cv2.resizeWindow('pic', 1200, 800)  # å¯è§†åŒ–çš„å›¾ç‰‡å¤§å°
    cv2.imshow('pic', img)
    cv2.waitKey(0)
    cv2.destroyAllWindows()


# å›¾åƒå‡ä¸ºcv2è¯»å–
class DataAugmentForObjectDetection():
    def __init__(self, rotation_rate=0.5, max_rotation_angle=5,
                 crop_rate=0.5, shift_rate=0.5, change_light_rate=0.5,
                 add_noise_rate=0.5, flip_rate=0.5,
                 cutout_rate=0.5, cut_out_length=50, cut_out_holes=1, cut_out_threshold=0.5,
                 is_addNoise=True, is_changeLight=True, is_cutout=True, is_rotate_img_bbox=True,
                 is_crop_img_bboxes=True, is_shift_pic_bboxes=True, is_filp_pic_bboxes=True):

        # é…ç½®å„ä¸ªæ“ä½œçš„å±æ€§
        self.rotation_rate = rotation_rate
        self.max_rotation_angle = max_rotation_angle
        self.crop_rate = crop_rate
        self.shift_rate = shift_rate
        self.change_light_rate = change_light_rate
        self.add_noise_rate = add_noise_rate
        self.flip_rate = flip_rate
        self.cutout_rate = cutout_rate

        self.cut_out_length = cut_out_length
        self.cut_out_holes = cut_out_holes
        self.cut_out_threshold = cut_out_threshold

        # æ˜¯å¦ä½¿ç”¨æŸç§å¢å¼ºæ–¹å¼
        self.is_addNoise = is_addNoise
        self.is_changeLight = is_changeLight
        self.is_cutout = is_cutout
        self.is_rotate_img_bbox = is_rotate_img_bbox
        self.is_crop_img_bboxes = is_crop_img_bboxes
        self.is_shift_pic_bboxes = is_shift_pic_bboxes
        self.is_filp_pic_bboxes = is_filp_pic_bboxes

    # ----1.åŠ å™ªå£°---- #
    def _addNoise(self, img):
        '''
        è¾“å…¥:
            img:å›¾åƒarray
        è¾“å‡º:
            åŠ å™ªå£°åçš„å›¾åƒarray,ç”±äºè¾“å‡ºçš„åƒç´ æ˜¯åœ¨[0,1]ä¹‹é—´,æ‰€ä»¥å¾—ä¹˜ä»¥255
        '''
        # return cv2.GaussianBlur(img, (11, 11), 0)
        return random_noise(img, mode='gaussian', seed=int(time.time()), clip=True) * 255

    # ---2.è°ƒæ•´äº®åº¦--- #
    def _changeLight(self, img):
        alpha = random.uniform(0.35, 1)
        blank = np.zeros(img.shape, img.dtype)
        return cv2.addWeighted(img, alpha, blank, 1 - alpha, 0)

    # ---3.cutout--- #
    def _cutout(self, img, bboxes, length=100, n_holes=1, threshold=0.5):
        '''
        åŸç‰ˆæœ¬ï¼šhttps://github.com/uoguelph-mlrg/Cutout/blob/master/util/cutout.py
        Randomly mask out one or more patches from an image.
        Args:
            img : a 3D numpy array,(h,w,c)
            bboxes : æ¡†çš„åæ ‡
            n_holes (int): Number of patches to cut out of each image.
            length (int): The length (in pixels) of each square patch.
        '''

        def cal_iou(boxA, boxB):
            '''
            boxA, boxBä¸ºä¸¤ä¸ªæ¡†ï¼Œè¿”å›iou
            boxBä¸ºbouding box
            '''
            # determine the (x, y)-coordinates of the intersection rectangle
            xA = max(boxA[0], boxB[0])
            yA = max(boxA[1], boxB[1])
            xB = min(boxA[2], boxB[2])
            yB = min(boxA[3], boxB[3])

            if xB <= xA or yB <= yA:
                return 0.0

            # compute the area of intersection rectangle
            interArea = (xB - xA + 1) * (yB - yA + 1)

            # compute the area of both the prediction and ground-truth
            # rectangles
            boxAArea = (boxA[2] - boxA[0] + 1) * (boxA[3] - boxA[1] + 1)
            boxBArea = (boxB[2] - boxB[0] + 1) * (boxB[3] - boxB[1] + 1)
            iou = interArea / float(boxBArea)
            return iou

        # å¾—åˆ°hå’Œw
        if img.ndim == 3:
            h, w, c = img.shape
        else:
            _, h, w, c = img.shape
        mask = np.ones((h, w, c), np.float32)
        for n in range(n_holes):
            chongdie = True  # çœ‹åˆ‡å‰²çš„åŒºåŸŸæ˜¯å¦ä¸boxé‡å å¤ªå¤š
            while chongdie:
                y = np.random.randint(h)
                x = np.random.randint(w)

                y1 = np.clip(y - length // 2, 0,
                             h)  # numpy.clip(a, a_min, a_max, out=None), clipè¿™ä¸ªå‡½æ•°å°†å°†æ•°ç»„ä¸­çš„å…ƒç´ é™åˆ¶åœ¨a_min, a_maxä¹‹é—´ï¼Œå¤§äºa_maxçš„å°±ä½¿å¾—å®ƒç­‰äº a_maxï¼Œå°äºa_min,çš„å°±ä½¿å¾—å®ƒç­‰äºa_min
                y2 = np.clip(y + length // 2, 0, h)
                x1 = np.clip(x - length // 2, 0, w)
                x2 = np.clip(x + length // 2, 0, w)

                chongdie = False
                for box in bboxes:
                    if cal_iou([x1, y1, x2, y2], box) > threshold:
                        chongdie = True
                        break
            mask[y1: y2, x1: x2, :] = 0.
        img = img * mask
        return img

    # ---4.æ—‹è½¬--- #
    def _rotate_img_bbox(self, img, bboxes, angle=5, scale=1.):
        '''
        å‚è€ƒ:https://blog.csdn.net/u014540717/article/details/53301195crop_rate
        è¾“å…¥:
            img:å›¾åƒarray,(h,w,c)
            bboxes:è¯¥å›¾åƒåŒ…å«çš„æ‰€æœ‰boundingboxs,ä¸€ä¸ªlist,æ¯ä¸ªå…ƒç´ ä¸º[x_min, y_min, x_max, y_max],è¦ç¡®ä¿æ˜¯æ•°å€¼
            angle:æ—‹è½¬è§’åº¦
            scale:é»˜è®¤1
        è¾“å‡º:
            rot_img:æ—‹è½¬åçš„å›¾åƒarray
            rot_bboxes:æ—‹è½¬åçš„boundingboxåæ ‡list
        '''
        # æ—‹è½¬å›¾åƒ
        w = img.shape[1]
        h = img.shape[0]
        # è§’åº¦å˜å¼§åº¦
        rangle = np.deg2rad(angle)  # angle in radians
        # now calculate new image width and height
        nw = (abs(np.sin(rangle) * h) + abs(np.cos(rangle) * w)) * scale
        nh = (abs(np.cos(rangle) * h) + abs(np.sin(rangle) * w)) * scale
        # ask OpenCV for the rotation matrix
        rot_mat = cv2.getRotationMatrix2D((nw * 0.5, nh * 0.5), angle, scale)
        # calculate the move from the old center to the new center combined
        # with the rotation
        rot_move = np.dot(rot_mat, np.array([(nw - w) * 0.5, (nh - h) * 0.5, 0]))
        # the move only affects the translation, so update the translation
        rot_mat[0, 2] += rot_move[0]
        rot_mat[1, 2] += rot_move[1]
        # ä»¿å°„å˜æ¢
        rot_img = cv2.warpAffine(img, rot_mat, (int(math.ceil(nw)), int(math.ceil(nh))), flags=cv2.INTER_LANCZOS4)

        # çŸ«æ­£bboxåæ ‡
        # rot_matæ˜¯æœ€ç»ˆçš„æ—‹è½¬çŸ©é˜µ
        # è·å–åŸå§‹bboxçš„å››ä¸ªä¸­ç‚¹ï¼Œç„¶åå°†è¿™å››ä¸ªç‚¹è½¬æ¢åˆ°æ—‹è½¬åçš„åæ ‡ç³»ä¸‹
        rot_bboxes = list()
        for bbox in bboxes:
            xmin = bbox[0]
            ymin = bbox[1]
            xmax = bbox[2]
            ymax = bbox[3]
            point1 = np.dot(rot_mat, np.array([(xmin + xmax) / 2, ymin, 1]))
            point2 = np.dot(rot_mat, np.array([xmax, (ymin + ymax) / 2, 1]))
            point3 = np.dot(rot_mat, np.array([(xmin + xmax) / 2, ymax, 1]))
            point4 = np.dot(rot_mat, np.array([xmin, (ymin + ymax) / 2, 1]))
            # åˆå¹¶np.array
            concat = np.vstack((point1, point2, point3, point4))
            # æ”¹å˜arrayç±»å‹
            concat = concat.astype(np.int32)
            # å¾—åˆ°æ—‹è½¬åçš„åæ ‡
            rx, ry, rw, rh = cv2.boundingRect(concat)
            rx_min = rx
            ry_min = ry
            rx_max = rx + rw
            ry_max = ry + rh
            # åŠ å…¥listä¸­
            rot_bboxes.append([rx_min, ry_min, rx_max, ry_max])

        return rot_img, rot_bboxes

    # ---5.è£å‰ª--- #
    def _crop_img_bboxes(self, img, bboxes):
        '''
        è£å‰ªåçš„å›¾ç‰‡è¦åŒ…å«æ‰€æœ‰çš„æ¡†
        è¾“å…¥:
            img:å›¾åƒarray
            bboxes:è¯¥å›¾åƒåŒ…å«çš„æ‰€æœ‰boundingboxs,ä¸€ä¸ªlist,æ¯ä¸ªå…ƒç´ ä¸º[x_min, y_min, x_max, y_max],è¦ç¡®ä¿æ˜¯æ•°å€¼
        è¾“å‡º:
            crop_img:è£å‰ªåçš„å›¾åƒarray
            crop_bboxes:è£å‰ªåçš„bounding boxçš„åæ ‡list
        '''
        # è£å‰ªå›¾åƒ
        w = img.shape[1]
        h = img.shape[0]
        x_min = w  # è£å‰ªåçš„åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°çš„æ¡†
        x_max = 0
        y_min = h
        y_max = 0
        for bbox in bboxes:
            x_min = min(x_min, bbox[0])
            y_min = min(y_min, bbox[1])
            x_max = max(x_max, bbox[2])
            y_max = max(y_max, bbox[3])

        d_to_left = x_min  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°æ¡†åˆ°å·¦è¾¹çš„è·ç¦»
        d_to_right = w - x_max  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°æ¡†åˆ°å³è¾¹çš„è·ç¦»
        d_to_top = y_min  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°æ¡†åˆ°é¡¶ç«¯çš„è·ç¦»
        d_to_bottom = h - y_max  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°æ¡†åˆ°åº•éƒ¨çš„è·ç¦»

        # éšæœºæ‰©å±•è¿™ä¸ªæœ€å°æ¡†
        crop_x_min = int(x_min - random.uniform(0, d_to_left))
        crop_y_min = int(y_min - random.uniform(0, d_to_top))
        crop_x_max = int(x_max + random.uniform(0, d_to_right))
        crop_y_max = int(y_max + random.uniform(0, d_to_bottom))

        # éšæœºæ‰©å±•è¿™ä¸ªæœ€å°æ¡† , é˜²æ­¢åˆ«è£çš„å¤ªå°
        # crop_x_min = int(x_min - random.uniform(d_to_left//2, d_to_left))
        # crop_y_min = int(y_min - random.uniform(d_to_top//2, d_to_top))
        # crop_x_max = int(x_max + random.uniform(d_to_right//2, d_to_right))
        # crop_y_max = int(y_max + random.uniform(d_to_bottom//2, d_to_bottom))

        # ç¡®ä¿ä¸è¦è¶Šç•Œ
        crop_x_min = max(0, crop_x_min)
        crop_y_min = max(0, crop_y_min)
        crop_x_max = min(w, crop_x_max)
        crop_y_max = min(h, crop_y_max)

        crop_img = img[crop_y_min:crop_y_max, crop_x_min:crop_x_max]

        # è£å‰ªboundingbox
        # è£å‰ªåçš„boundingboxåæ ‡è®¡ç®—
        crop_bboxes = list()
        for bbox in bboxes:
            crop_bboxes.append([bbox[0] - crop_x_min, bbox[1] - crop_y_min, bbox[2] - crop_x_min, bbox[3] - crop_y_min])

        return crop_img, crop_bboxes

    # ---6.å¹³ç§»--- #
    def _shift_pic_bboxes(self, img, bboxes):
        '''
        å¹³ç§»åçš„å›¾ç‰‡è¦åŒ…å«æ‰€æœ‰çš„æ¡†
        è¾“å…¥:
            img:å›¾åƒarray
            bboxes:è¯¥å›¾åƒåŒ…å«çš„æ‰€æœ‰boundingboxs,ä¸€ä¸ªlist,æ¯ä¸ªå…ƒç´ ä¸º[x_min, y_min, x_max, y_max],è¦ç¡®ä¿æ˜¯æ•°å€¼
        è¾“å‡º:
            shift_img:å¹³ç§»åçš„å›¾åƒarray
            shift_bboxes:å¹³ç§»åçš„bounding boxçš„åæ ‡list
        '''
        # å¹³ç§»å›¾åƒ
        w = img.shape[1]
        h = img.shape[0]
        x_min = w  # è£å‰ªåçš„åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å°çš„æ¡†
        x_max = 0
        y_min = h
        y_max = 0
        for bbox in bboxes:
            x_min = min(x_min, bbox[0])
            y_min = min(y_min, bbox[1])
            x_max = max(x_max, bbox[2])
            y_max = max(y_max, bbox[3])

        d_to_left = x_min  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å¤§å·¦ç§»åŠ¨è·ç¦»
        d_to_right = w - x_max  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å¤§å³ç§»åŠ¨è·ç¦»
        d_to_top = y_min  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å¤§ä¸Šç§»åŠ¨è·ç¦»
        d_to_bottom = h - y_max  # åŒ…å«æ‰€æœ‰ç›®æ ‡æ¡†çš„æœ€å¤§ä¸‹ç§»åŠ¨è·ç¦»

        x = random.uniform(-(d_to_left - 1) / 3, (d_to_right - 1) / 3)
        y = random.uniform(-(d_to_top - 1) / 3, (d_to_bottom - 1) / 3)

        M = np.float32([[1, 0, x], [0, 1, y]])  # xä¸ºå‘å·¦æˆ–å³ç§»åŠ¨çš„åƒç´ å€¼,æ­£ä¸ºå‘å³è´Ÿä¸ºå‘å·¦; yä¸ºå‘ä¸Šæˆ–è€…å‘ä¸‹ç§»åŠ¨çš„åƒç´ å€¼,æ­£ä¸ºå‘ä¸‹è´Ÿä¸ºå‘ä¸Š
        shift_img = cv2.warpAffine(img, M, (img.shape[1], img.shape[0]))

        #  å¹³ç§»boundingbox
        shift_bboxes = list()
        for bbox in bboxes:
            shift_bboxes.append([bbox[0] + x, bbox[1] + y, bbox[2] + x, bbox[3] + y])

        return shift_img, shift_bboxes

    # ---7.é•œåƒ--- #
    def _filp_pic_bboxes(self, img, bboxes):
        '''
            å¹³ç§»åçš„å›¾ç‰‡è¦åŒ…å«æ‰€æœ‰çš„æ¡†
            è¾“å…¥:
                img:å›¾åƒarray
                bboxes:è¯¥å›¾åƒåŒ…å«çš„æ‰€æœ‰boundingboxs,ä¸€ä¸ªlist,æ¯ä¸ªå…ƒç´ ä¸º[x_min, y_min, x_max, y_max],è¦ç¡®ä¿æ˜¯æ•°å€¼
            è¾“å‡º:
                flip_img:å¹³ç§»åçš„å›¾åƒarray
                flip_bboxes:å¹³ç§»åçš„bounding boxçš„åæ ‡list
        '''
        # ç¿»è½¬å›¾åƒ

        flip_img = copy.deepcopy(img)
        h, w, _ = img.shape

        sed = random.random()

        if 0 < sed < 0.33:  # 0.33çš„æ¦‚ç‡æ°´å¹³ç¿»è½¬ï¼Œ0.33çš„æ¦‚ç‡å‚ç›´ç¿»è½¬,0.33æ˜¯å¯¹è§’åè½¬
            flip_img = cv2.flip(flip_img, 0)  # _flip_x
            inver = 0
        elif 0.33 < sed < 0.66:
            flip_img = cv2.flip(flip_img, 1)  # _flip_y
            inver = 1
        else:
            flip_img = cv2.flip(flip_img, -1)  # flip_x_y
            inver = -1

        # è°ƒæ•´boundingbox
        flip_bboxes = list()
        for box in bboxes:
            x_min = box[0]
            y_min = box[1]
            x_max = box[2]
            y_max = box[3]

            if inver == 0:
                # 0ï¼šå‚ç›´ç¿»è½¬
                flip_bboxes.append([x_min, h - y_max, x_max, h - y_min])
            elif inver == 1:
                # 1ï¼šæ°´å¹³ç¿»è½¬
                flip_bboxes.append([w - x_max, y_min, w - x_min, y_max])
            elif inver == -1:
                # -1ï¼šæ°´å¹³å‚ç›´ç¿»è½¬
                flip_bboxes.append([w - x_max, h - y_max, w - x_min, h - y_min])
        return flip_img, flip_bboxes

    # å›¾åƒå¢å¼ºæ–¹æ³•
    def dataAugment(self, img, bboxes):
        '''
        å›¾åƒå¢å¼º
        è¾“å…¥:
            img:å›¾åƒarray
            bboxes:è¯¥å›¾åƒçš„æ‰€æœ‰æ¡†åæ ‡
        è¾“å‡º:
            img:å¢å¼ºåçš„å›¾åƒ
            bboxes:å¢å¼ºåå›¾ç‰‡å¯¹åº”çš„box
        '''
        change_num = 0  # æ”¹å˜çš„æ¬¡æ•°
        # print('------')
        while change_num < 1:  # é»˜è®¤è‡³å°‘æœ‰ä¸€ç§æ•°æ®å¢å¼ºç”Ÿæ•ˆ

            if self.is_rotate_img_bbox:
                if random.random() > self.rotation_rate:  # æ—‹è½¬
                    change_num += 1
                    angle = random.uniform(-self.max_rotation_angle, self.max_rotation_angle)
                    scale = random.uniform(0.7, 0.8)
                    img, bboxes = self._rotate_img_bbox(img, bboxes, angle, scale)

            if self.is_shift_pic_bboxes:
                if random.random() < self.shift_rate:  # å¹³ç§»
                    change_num += 1
                    img, bboxes = self._shift_pic_bboxes(img, bboxes)

            if self.is_changeLight:
                if random.random() > self.change_light_rate:  # æ”¹å˜äº®åº¦
                    change_num += 1
                    img = self._changeLight(img)

            if self.is_addNoise:
                if random.random() < self.add_noise_rate:  # åŠ å™ªå£°
                    change_num += 1
                    img = self._addNoise(img)
            if self.is_cutout:
                if random.random() < self.cutout_rate:  # cutout
                    change_num += 1
                    img = self._cutout(img, bboxes, length=self.cut_out_length, n_holes=self.cut_out_holes,
                                       threshold=self.cut_out_threshold)
            if self.is_filp_pic_bboxes:
                if random.random() < self.flip_rate:  # ç¿»è½¬
                    change_num += 1
                    img, bboxes = self._filp_pic_bboxes(img, bboxes)

        return img, bboxes


# xmlè§£æå·¥å…·
class ToolHelper():
    # ä»xmlæ–‡ä»¶ä¸­æå–bounding boxä¿¡æ¯, æ ¼å¼ä¸º[[x_min, y_min, x_max, y_max, name]]
    def parse_xml(self, path):
        '''
        è¾“å…¥ï¼š
            xml_path: xmlçš„æ–‡ä»¶è·¯å¾„
        è¾“å‡ºï¼š
            ä»xmlæ–‡ä»¶ä¸­æå–bounding boxä¿¡æ¯, æ ¼å¼ä¸º[[x_min, y_min, x_max, y_max, name]]
        '''
        tree = ET.parse(path)
        root = tree.getroot()
        objs = root.findall('object')
        coords = list()
        for ix, obj in enumerate(objs):
            name = obj.find('name').text
            box = obj.find('bndbox')
            x_min = int(box[0].text)
            y_min = int(box[1].text)
            x_max = int(box[2].text)
            y_max = int(box[3].text)
            coords.append([x_min, y_min, x_max, y_max, name])
        return coords

    # ä¿å­˜å›¾ç‰‡ç»“æœ
    def save_img(self, file_name, save_folder, img):
        cv2.imwrite(os.path.join(save_folder, file_name), img)

    # ä¿æŒxmlç»“æœ
    def save_xml(self, file_name, save_folder, img_info, height, width, channel, bboxs_info):
        '''
        :param file_name:æ–‡ä»¶å
        :param save_folder:#ä¿å­˜çš„xmlæ–‡ä»¶çš„ç»“æœ
        :param height:å›¾ç‰‡çš„ä¿¡æ¯
        :param width:å›¾ç‰‡çš„å®½åº¦
        :param channel:é€šé“
        :return:
        '''
        folder_name, img_name = img_info  # å¾—åˆ°å›¾ç‰‡çš„ä¿¡æ¯

        E = objectify.ElementMaker(annotate=False)

        anno_tree = E.annotation(
            E.folder(folder_name),
            E.filename(img_name),
            E.path(os.path.join(folder_name, img_name)),
            E.source(
                E.database('Unknown'),
            ),
            E.size(
                E.width(width),
                E.height(height),
                E.depth(channel)
            ),
            E.segmented(0),
        )

        labels, bboxs = bboxs_info  # å¾—åˆ°è¾¹æ¡†å’Œæ ‡ç­¾ä¿¡æ¯
        for label, box in zip(labels, bboxs):
            anno_tree.append(
                E.object(
                    E.name(label),
                    E.pose('Unspecified'),
                    E.truncated('0'),
                    E.difficult('0'),
                    E.bndbox(
                        E.xmin(box[0]),
                        E.ymin(box[1]),
                        E.xmax(box[2]),
                        E.ymax(box[3])
                    )
                ))

        etree.ElementTree(anno_tree).write(os.path.join(save_folder, file_name), pretty_print=True)


if __name__ == '__main__':

    need_aug_num = 5  # æ¯å¼ å›¾ç‰‡éœ€è¦å¢å¼ºçš„æ¬¡æ•°

    is_endwidth_dot = True  # æ–‡ä»¶æ˜¯å¦ä»¥.jpgæˆ–è€…pngç»“å°¾

    dataAug = DataAugmentForObjectDetection()  # æ•°æ®å¢å¼ºå·¥å…·ç±»

    toolhelper = ToolHelper()  # å·¥å…·

    # è·å–ç›¸å…³å‚æ•°
    parser = argparse.ArgumentParser()
    parser.add_argument('--source_img_path', type=str, default='D:\@Graduation\enhance\images')
    parser.add_argument('--source_xml_path', type=str, default='D:\@Graduation\enhance\labels')
    parser.add_argument('--save_img_path', type=str, default='D:\@Graduation\enhance\images2')
    parser.add_argument('--save_xml_path', type=str, default='D:\@Graduation\enhance\Annotations2')
    args = parser.parse_args()
    source_img_path = args.source_img_path  # å›¾ç‰‡åŸå§‹ä½ç½®
    source_xml_path = args.source_xml_path  # xmlçš„åŸå§‹ä½ç½®

    save_img_path = args.save_img_path  # å›¾ç‰‡å¢å¼ºç»“æœä¿å­˜æ–‡ä»¶
    save_xml_path = args.save_xml_path  # xmlå¢å¼ºç»“æœä¿å­˜æ–‡ä»¶

    # å¦‚æœä¿å­˜æ–‡ä»¶å¤¹ä¸å­˜åœ¨å°±åˆ›å»º
    if not os.path.exists(save_img_path):
        os.mkdir(save_img_path)

    if not os.path.exists(save_xml_path):
        os.mkdir(save_xml_path)

    for parent, _, files in os.walk(source_img_path):
        files.sort()
        for file in files:
            cnt = 0
            pic_path = os.path.join(parent, file)
            xml_path = os.path.join(source_xml_path, file[:-4] + '.xml')
            values = toolhelper.parse_xml(xml_path)  # è§£æå¾—åˆ°boxä¿¡æ¯ï¼Œæ ¼å¼ä¸º[[x_min,y_min,x_max,y_max,name]]
            coords = [v[:4] for v in values]  # å¾—åˆ°æ¡†
            labels = [v[-1] for v in values]  # å¯¹è±¡çš„æ ‡ç­¾

            # å¦‚æœå›¾ç‰‡æ˜¯æœ‰åç¼€çš„
            if is_endwidth_dot:
                # æ‰¾åˆ°æ–‡ä»¶çš„æœ€ååå­—
                dot_index = file.rfind('.')
                _file_prefix = file[:dot_index]  # æ–‡ä»¶åçš„å‰ç¼€
                _file_suffix = file[dot_index:]  # æ–‡ä»¶åçš„åç¼€
            img = cv2.imread(pic_path)

            # show_pic(img, coords)  # æ˜¾ç¤ºåŸå›¾
            while cnt < need_aug_num:  # ç»§ç»­å¢å¼º
                auged_img, auged_bboxes = dataAug.dataAugment(img, coords)
                auged_bboxes_int = np.array(auged_bboxes).astype(np.int32)
                height, width, channel = auged_img.shape  # å¾—åˆ°å›¾ç‰‡çš„å±æ€§
                img_name = '{}_{}{}'.format(_file_prefix, cnt + 1, _file_suffix)  # å›¾ç‰‡ä¿å­˜çš„ä¿¡æ¯
                toolhelper.save_img(img_name, save_img_path,
                                    auged_img)  # ä¿å­˜å¢å¼ºå›¾ç‰‡

                toolhelper.save_xml('{}_{}.xml'.format(_file_prefix, cnt + 1),
                                    save_xml_path, (save_img_path, img_name), height, width, channel,
                                    (labels, auged_bboxes_int))  # ä¿å­˜xmlæ–‡ä»¶
                # show_pic(auged_img, auged_bboxes)  # å¼ºåŒ–åçš„å›¾
                print(img_name)
                cnt += 1  # ç»§ç»­å¢å¼ºä¸‹ä¸€å¼ 
```

**è¿™æ˜¯æ‰©å……æ•°æ®é›†åçš„æ•ˆæœå›¾ï¼š**

![](https://bu.dusays.com/2024/04/11/6617aa185934d.webp)

**æ¥ä¸‹æ¥éœ€è¦å¯¹æ‰©å……å¥½çš„æ•°æ®é›†è¿›è¡Œ xml è½¬ txtï¼š**

```python
import xml.etree.ElementTree as ET
import os
from os import getcwd
import glob

# 1.
# è‡ªå·±åˆ›å»ºæ–‡ä»¶å¤¹,ä¾‹å¦‚ï¼šlabel_mal label_txt  ä¹Ÿå¯ä»¥ä¿®æ”¹åˆ«çš„
image_set = 'xml'  # éœ€è¦è½¬æ¢çš„æ–‡ä»¶å¤¹åç§°ï¼ˆæ–‡ä»¶å¤¹å†…æ”¾xmlæ ‡ç­¾æ–‡ä»¶ï¼‰
imageset2 = 'labels2'  # ä¿å­˜txtçš„æ–‡ä»¶å¤¹
# 2.
# æ¢æˆä½ çš„ç±»åˆ« å½“å‰çš„é¡ºåºï¼Œå°±txt 0,1,2,3 å››ä¸ªç±»åˆ«
classes = ['0']  # æ ‡æ³¨æ—¶çš„æ ‡ç­¾ æ³¨æ„é¡ºåºä¸€å®šä¸è¦é”™ã€‚

# 3.
# # è½¬æ¢æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„
# data_dir = 'D:/detectAuto_/data'
# æˆ–è€… è¯»å–å½“å‰è·¯å¾„
data_dir = getcwd()  # å½“å‰è·¯å¾„


'''
xmlä¸­æ¡†çš„å·¦ä¸Šè§’åæ ‡å’Œå³ä¸‹è§’åæ ‡(x1,y1,x2,y2)
ã€‹ã€‹txtä¸­çš„ä¸­å¿ƒç‚¹åæ ‡å’Œå®½å’Œé«˜(x,y,w,h)ï¼Œå¹¶ä¸”å½’ä¸€åŒ–
'''


def convert(size, box):
    dw = 1. / size[0]
    dh = 1. / size[1]
    x = (box[0] + box[1]) / 2.0
    y = (box[2] + box[3]) / 2.0
    w = box[1] - box[0]
    h = box[3] - box[2]
    x = x * dw
    w = w * dw
    y = y * dh
    h = h * dh
    return (x, y, w, h)


def convert_annotation(data_dir, imageset1, imageset2, image_id):
    in_file = open(data_dir + '/%s/%s.xml' % (imageset1, image_id),encoding='UTF-8')  # è¯»å–xml
    out_file = open(data_dir + '/%s/%s.txt' % (imageset2, image_id), 'w',encoding='UTF-8')  # ä¿å­˜txt

    tree = ET.parse(in_file)
    root = tree.getroot()
    size = root.find('size')
    w = int(size.find('width').text)
    h = int(size.find('height').text)
    for obj in root.iter('object'):
        difficult = obj.find('difficult').text
        cls = obj.find('name').text
        if cls not in classes or int(difficult) == 1:
            continue
        cls_id = classes.index(cls)  # è·å–ç±»åˆ«ç´¢å¼•
        xmlbox = obj.find('bndbox')
        b = (float(xmlbox.find('xmin').text), float(xmlbox.find('xmax').text), float(xmlbox.find('ymin').text),
             float(xmlbox.find('ymax').text))
        bb = convert((w, h), b)
        out_file.write(str(cls_id) + " " + " ".join([str('%.6f' % a) for a in bb]) + '\n')


image_ids = []
for x in glob.glob(data_dir + '/%s' % image_set + '/*.xml'):
    image_ids.append(os.path.basename(x)[:-4])
print('\n%sæ•°é‡:' % image_set, len(image_ids))  # ç¡®è®¤æ•°é‡
i = 0
for image_id in image_ids:
    i = i + 1
    convert_annotation(data_dir, image_set, imageset2, image_id)
    print("%s æ•°æ®:%s/%sæ–‡ä»¶å®Œæˆï¼" % (image_set, i, len(image_ids)))

print("Done!!!")
```

ç„¶åæ‰“åŒ…å¥½æ•°æ®é›†ä¸Šä¼ æœåŠ¡å™¨

## Autodl è®­ç»ƒæ•ˆæœ

---

ç”±äºå¼•å…¥äº†æ•°æ®é›†è¿›è¡Œæ‰©å……åï¼Œå›¾ç‰‡çš„æ•°é‡å¢å¤šï¼Œè®­ç»ƒæ—¶é—´ä¹Ÿæ›´é•¿ã€‚

**50 è½®è®­ç»ƒçš„æ•ˆæœå›¾ï¼š**

![](https://bu.dusays.com/2024/04/11/6617ab85ad332.webp)

![](https://bu.dusays.com/2024/04/11/6617abad2cda9.webp)

**60 è½®è®­ç»ƒçš„æ•ˆæœå›¾ï¼š**

![](https://bu.dusays.com/2024/04/11/6617ac328a49e.webp)

![](https://bu.dusays.com/2024/04/11/6617ac3d49907.webp)

**100 è½®è®­ç»ƒçš„æ•ˆæœå›¾ï¼š**

![](https://bu.dusays.com/2024/04/11/6617b28c2adf3.webp)

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/81a75f5f-eb3b-47db-bd61-d87d1cd413a6/e7ed53b3-ac03-4882-8685-215b5d5f586f/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240415%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240415T133651Z&X-Amz-Expires=3600&X-Amz-Signature=90e6dc697948e10866750556115849c88bd47bda427e256cf7c01df03910d191&X-Amz-SignedHeaders=host&x-id=GetObject)

åº”è¯¥è¿˜æ˜¯æ•°æ®é›†çš„é—®é¢˜ï¼Œå‡ºç°äº†è¿‡æ‹Ÿåˆçš„ç°è±¡ã€‚ä¹‹åè‚¯å®šè¿˜éœ€è¦å¯¹æ•°æ®é›†è¿›è¡Œè°ƒæ•´ï¼Œå¦å¤–ç”±äºé‡‡ç”¨çš„æ˜¯æœ€å¿«çš„è®­ç»ƒæ¨¡å‹ï¼Œåœ¨è®­ç»ƒç²¾åº¦ä¸Šè‚¯å®šè¿˜æœ‰æå‡çš„ç©ºé—´ã€‚ä½†ä¹‹å‰åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜å‡ºç°äº†ä¸€äº›æŠ¥é”™çš„æƒ…å†µï¼Œéœ€è¦å†èŠ±æ—¶é—´ç ”ç©¶ç ”ç©¶ã€‚

## æµ‹è¯•æ¨¡å—çš„ç¼–å†™

---

åœ¨è®¾è®¡ GUI ä¹‹å‰ï¼Œéœ€è¦åˆæ­¥å®Œæˆå›¾ç‰‡å’Œè§†é¢‘æ£€æµ‹çš„ç¨‹åºç¼–å†™

**1.å›¾ç‰‡æ£€æµ‹æµ‹è¯•-æ ¸å¿ƒä»£ç æ‘˜å½•**

```python
def predict(img):
    img = torch.from_numpy(img).to(device)
    img = img.half() if half else img.float()
    img /= 255.0
    if img.ndimension() == 3:
        img = img.unsqueeze(0)

    t1 = time_synchronized()
    pred = model(img, augment=False)[0]
    pred = non_max_suppression(pred, opt.conf_thres, opt.iou_thres, classes=opt.classes,
                               agnostic=opt.agnostic_nms)
    t2 = time_synchronized()
    InferNms = round((t2 - t1), 2)

    return pred, InferNms


def cv_imread(filePath):
    # è¯»å–å›¾ç‰‡
    cv_img = cv2.imdecode(np.fromfile(filePath, dtype=np.uint8), -1)

    if len(cv_img.shape) > 2:
        if cv_img.shape[2] > 3:
            cv_img = cv_img[:, :, :3]
    return cv_img


def plot_one_box(img, x, color=None, label=None, line_thickness=None):
    # Plots one bounding box on image img
    tl = line_thickness or round(0.002 * (img.shape[0] + img.shape[1]) / 2) + 1  # line/font thickness
    color = color or [random.randint(0, 255) for _ in range(3)]
    c1, c2 = (int(x[0]), int(x[1])), (int(x[2]), int(x[3]))
    cv2.rectangle(img, c1, c2, color, thickness=tl, lineType=cv2.LINE_AA)
    if label:
        tf = max(tl - 1, 1)  # font thickness
        t_size = cv2.getTextSize(label, 0, fontScale=tl / 3, thickness=tf)[0]
        c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3
        cv2.rectangle(img, c1, c2, color, -1, cv2.LINE_AA)  # filled
        cv2.putText(img, label, (c1[0], c1[1] - 2), 0, tl / 3, [225, 255, 255], thickness=tf, lineType=cv2.LINE_AA)


if __name__ == '__main__':
    img_path = "./UI_rec/testpicture/000743_slice_3_5.jpg"
    image = cv_imread(img_path)
    image = cv2.resize(image, (640, 640))
    img0 = image.copy()
    img = letterbox(img0, new_shape=imgsz)[0]
    img = np.stack(img, 0)
    img = img[:, :, ::-1].transpose(2, 0, 1)  # BGR to RGB, to 3x416x416
    img = np.ascontiguousarray(img)

    pred, useTime = predict(img)

    det = pred[0]
    p, s, im0 = None, '', img0
    if det is not None and len(det):  # å¦‚æœæœ‰æ£€æµ‹ä¿¡æ¯åˆ™è¿›å…¥
        det[:, :4] = scale_coords(img.shape[1:], det[:, :4], im0.shape).round()  # æŠŠå›¾åƒç¼©æ”¾è‡³im0çš„å°ºå¯¸
        number_i = 0  # ç±»åˆ«é¢„ç¼–å·
        detInfo = []
        for *xyxy, conf, cls in reversed(det):  # éå†æ£€æµ‹ä¿¡æ¯
            c1, c2 = (int(xyxy[0]), int(xyxy[1])), (int(xyxy[2]), int(xyxy[3]))
            # å°†æ£€æµ‹ä¿¡æ¯æ·»åŠ åˆ°å­—å…¸ä¸­
            detInfo.append([names[int(cls)], [c1[0], c1[1], c2[0], c2[1]], '%.2f' % conf])
            number_i += 1  # ç¼–å·æ•°+1

            label = '%s %.2f' % (names[int(cls)], conf)

            # ç”»å‡ºæ£€æµ‹åˆ°çš„ç›®æ ‡ç‰©
            plot_one_box(image, xyxy, label=label, color=colors[int(cls)])
    # å®æ—¶æ˜¾ç¤ºæ£€æµ‹ç”»é¢
    cv2.imshow('Stream', image)
    # if cv2.waitKey(1) & 0xFF == ord('q'):
    #     break
    c = cv2.waitKey(0) & 0xff

```

![](https://bu.dusays.com/2024/04/11/6617d07e11f63.webp)

2.**è§†é¢‘æ£€æµ‹æµ‹è¯•-æ ¸å¿ƒä»£ç æ‘˜å½•**

```python
def predict(img):
    img = torch.from_numpy(img).to(device)
    img = img.half() if half else img.float()
    img /= 255.0
    if img.ndimension() == 3:
        img = img.unsqueeze(0)

    t1 = time_synchronized()
    pred = model(img, augment=False)[0]
    pred = non_max_suppression(pred, opt.conf_thres, opt.iou_thres, classes=opt.classes,
                               agnostic=opt.agnostic_nms)
    t2 = time_synchronized()
    InferNms = round((t2 - t1), 2)

    return pred, InferNms


def plot_one_box(img, x, color=None, label=None, line_thickness=None):
    # Plots one bounding box on image img
    tl = line_thickness or round(0.002 * (img.shape[0] + img.shape[1]) / 2) + 1  # line/font thickness
    color = color or [random.randint(0, 255) for _ in range(3)]
    c1, c2 = (int(x[0]), int(x[1])), (int(x[2]), int(x[3]))
    cv2.rectangle(img, c1, c2, color, thickness=tl, lineType=cv2.LINE_AA)
    if label:
        tf = max(tl - 1, 1)  # font thickness
        t_size = cv2.getTextSize(label, 0, fontScale=tl / 3, thickness=tf)[0]
        c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3
        cv2.rectangle(img, c1, c2, color, -1, cv2.LINE_AA)  # filled
        cv2.putText(img, label, (c1[0], c1[1] - 2), 0, tl / 3, [225, 255, 255], thickness=tf, lineType=cv2.LINE_AA)


if __name__ == '__main__':
    #video_path = 1
    video_path = "UI_rec/testvideo/test.mp4"
    # åˆå§‹åŒ–è§†é¢‘æµ
    vs = cv2.VideoCapture(video_path)
    (W, H) = (None, None)
    frameIndex = 0  # è§†é¢‘å¸§æ•°

    try:
        prop = cv2.CAP_PROP_FRAME_COUNT
        total = int(vs.get(prop))
        # print("[INFO] è§†é¢‘æ€»å¸§æ•°ï¼š{}".format(total))
    # è‹¥è¯»å–å¤±è´¥ï¼ŒæŠ¥é”™é€€å‡º
    except:
        print("[INFO] could not determine # of frames in video")
        print("[INFO] no approx. completion time can be provided")
        total = -1

    fourcc = cv2.VideoWriter_fourcc(*'XVID')
    ret, frame = vs.read()
    vw = frame.shape[1]
    vh = frame.shape[0]
    print("[INFO] è§†é¢‘å°ºå¯¸ï¼š{} * {}".format(vw, vh))
    output_video = cv2.VideoWriter("./UI_rec/result/results.avi", fourcc, 20.0, (vw, vh))  # å¤„ç†åçš„è§†é¢‘å¯¹è±¡

    # éå†è§†é¢‘å¸§è¿›è¡Œæ£€æµ‹
    while True:
        # ä»è§†é¢‘æ–‡ä»¶ä¸­é€å¸§è¯»å–ç”»é¢
        (grabbed, image) = vs.read()

        # è‹¥grabbedä¸ºç©ºï¼Œè¡¨ç¤ºè§†é¢‘åˆ°è¾¾æœ€åä¸€å¸§ï¼Œé€€å‡º
        if not grabbed:
            print("[INFO] è¿è¡Œç»“æŸ...")
            output_video.release()
            vs.release()
            exit()
        # è·å–ç”»é¢é•¿å®½
        if W is None or H is None:
            (H, W) = image.shape[:2]

        image = cv2.resize(image, (640, 640))
        img0 = image.copy()
        img = letterbox(img0, new_shape=imgsz)[0]
        img = np.stack(img, 0)
        img = img[:, :, ::-1].transpose(2, 0, 1)  # BGR to RGB, to 3x416x416
        img = np.ascontiguousarray(img)

        pred, useTime = predict(img)

        det = pred[0]
        p, s, im0 = None, '', img0
        if det is not None and len(det):  # å¦‚æœæœ‰æ£€æµ‹ä¿¡æ¯åˆ™è¿›å…¥
            det[:, :4] = scale_coords(img.shape[1:], det[:, :4], im0.shape).round()  # æŠŠå›¾åƒç¼©æ”¾è‡³im0çš„å°ºå¯¸
            number_i = 0  # ç±»åˆ«é¢„ç¼–å·
            detInfo = []
            for *xyxy, conf, cls in reversed(det):  # éå†æ£€æµ‹ä¿¡æ¯
                c1, c2 = (int(xyxy[0]), int(xyxy[1])), (int(xyxy[2]), int(xyxy[3]))
                # å°†æ£€æµ‹ä¿¡æ¯æ·»åŠ åˆ°å­—å…¸ä¸­
                detInfo.append([names[int(cls)], [c1[0], c1[1], c2[0], c2[1]], '%.2f' % conf])
                number_i += 1  # ç¼–å·æ•°+1

                label = '%s %.2f' % (names[int(cls)], conf)

                # ç”»å‡ºæ£€æµ‹åˆ°çš„ç›®æ ‡ç‰©
                plot_one_box(image, xyxy, label=label, color=colors[int(cls)])

        # å®æ—¶æ˜¾ç¤ºæ£€æµ‹ç”»é¢
        cv2.imshow('Stream', image)
        image = cv2.resize(image, (vw, vh))
        output_video.write(image)  # ä¿å­˜æ ‡è®°åçš„è§†é¢‘
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

        # print("FPS:{}".format(int(0.6/(end-start))))
        frameIndex += 1

        # if frameIndex >= total:  # å¯è®¾ç½®æ£€æµ‹çš„æœ€å¤§å¸§æ•°æå‰é€€å‡º
        #     print("[INFO] è¿è¡Œç»“æŸ...")
        #     output_video.release()
        #     vs.release()
        #     exit()
```

[æ•ˆæœå‘ˆç°](https://www.bilibili.com/video/BV1Lm421E7M2/?spm_id_from=333.999.0.0&vd_source=237e295a40d7aaea043ead8c0d2c78ab)

## GUI ç•Œé¢

---

![](https://bu.dusays.com/2024/04/11/6617b40a08bdb.webp)

**ä¸»æ§ç¨‹åºï¼š**

```python
# -*- coding: utf-8 -*-
# runMain.py
from sys import argv, exit
#è¿™è¡Œä»£ç ä»sysæ¨¡å—ä¸­å¯¼å…¥äº†ä¸¤ä¸ªå‡½æ•°ï¼šargvå’Œexitã€‚argvæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°çš„åˆ—è¡¨ï¼Œå½“ä»ç»ˆç«¯è¿è¡ŒPythonè„šæœ¬æ—¶ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåˆ—è¡¨è®¿é—®è¿™äº›å‚æ•°ã€‚exitå‡½æ•°ç”¨äºé€€å‡ºPythonç¨‹åºã€‚
from PyQt5.QtWidgets import QApplication
#è¿™è¡Œä»£ç ä»PyQt5çš„QtWidgetsæ¨¡å—ä¸­å¯¼å…¥äº†QApplicationç±»ã€‚QApplicationç±»ç®¡ç†GUIåº”ç”¨ç¨‹åºçš„æ§åˆ¶æµå’Œä¸»è¦è®¾ç½®ï¼Œæ˜¯æ‰€æœ‰åŸºäºQtçš„GUIåº”ç”¨ç¨‹åºçš„èµ·ç‚¹ã€‚
from bboxRecognition import bbox_MainWindow
#è¿™è¡Œä»£ç ä»bboxRecognitionæ¨¡å—ï¼ˆå¯èƒ½æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡å—ï¼‰ä¸­å¯¼å…¥äº†ä¸€ä¸ªåä¸ºbbox_MainWindowçš„ç±»ã€‚è¿™ä¸ªç±»ç”¨äºè¯†åˆ«é»‘åŒ£å­ã€‚
if __name__ == '__main__':
#è¿™è¡Œä»£ç æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œè€Œä¸æ˜¯ä½œä¸ºæ¨¡å—å¯¼å…¥åˆ°å…¶ä»–è„šæœ¬ä¸­ã€‚å¦‚æœæ˜¯ç›´æ¥è¿è¡Œï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç å—å°†è¢«æ‰§è¡Œ
    app = QApplication(argv)
#è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªQApplicationå®ä¾‹ï¼Œå®ƒæ˜¯ä»»ä½•PyQt5åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚argvå‚æ•°ä¼ é€’ç»™QApplicationï¼Œè¿™æ ·å®ƒå°±å¯ä»¥å¤„ç†æ¥è‡ªå‘½ä»¤è¡Œçš„å‚æ•°ã€‚
    win = bbox_MainWindow()
#è¿™è¡Œä»£ç åˆ›å»ºäº†box_MainWindowç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å¾ˆå¯èƒ½æ˜¯åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ã€‚
    win.showTime()
#ä¸æ—¶é—´ç›¸å…³çš„åŠŸèƒ½ã€‚
    exit(app.exec_())
#æœ€åï¼Œè¿™è¡Œä»£ç å¯åŠ¨äº†åº”ç”¨ç¨‹åºçš„ä¸»äº‹ä»¶å¾ªç¯ï¼Œé€šè¿‡è°ƒç”¨exec_()æ–¹æ³•ã€‚å½“äº‹ä»¶å¾ªç¯å¼€å§‹åï¼Œåº”ç”¨ç¨‹åºå°†ç­‰å¾…ç”¨æˆ·äº‹ä»¶å¹¶å“åº”ä»–ä»¬ã€‚exitå‡½æ•°ç¡®ä¿åº”ç”¨ç¨‹åºå¯ä»¥å¹²å‡€åœ°é€€å‡ºï¼Œè¿”å›ç å°†ä¼ é€’ç»™exitï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿå¯ä»¥çŸ¥é“ç¨‹åºæ˜¯æ­£å¸¸é€€å‡ºè¿˜æ˜¯å‘ç”Ÿäº†é”™è¯¯ã€‚
```

**ç®€è¦æ‘˜å½•æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼š**

1.å¯åŠ¨ GUI ç•Œé¢

```python
#è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸ºbbox_MainWindowçš„ç±»ï¼Œå®ƒç»§æ‰¿è‡ªQBeautyUIã€‚è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªGUIçª—å£ï¼Œç”¨äºæŸç§ç›®æ ‡æ£€æµ‹æˆ–è€…è§†é¢‘å¤„ç†åº”ç”¨ç¨‹åºã€‚
class bbox_MainWindow(QBeautyUI):
    #è¿™è¡Œä»£ç è°ƒç”¨çˆ¶ç±»QBeautyUIçš„æ„é€ å‡½æ•°ï¼Œç¡®ä¿ç»§æ‰¿çš„åŠŸèƒ½å¾—åˆ°æ­£ç¡®åˆå§‹åŒ–ã€‚
    def __init__(self, *args, obj=None, **kwargs):
        super(bbox_MainWindow, self).__init__(*args, **kwargs)

        self.setupUi(self)  # ç•Œé¢ç”Ÿæˆ
        self.retranslateUi(self)  # ç•Œé¢æ§ä»¶
        #è¿™ä¸¤è¡Œä»£ç å¯èƒ½è°ƒç”¨äº†åœ¨QBeautyUIä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ–å’Œè®¾ç½®ç”¨æˆ·ç•Œé¢ã€‚
        self.setUiStyle(window_flag=True, transBack_flag=True)  # è®¾ç½®ç•Œé¢æ ·å¼
        #è¿™è¡Œä»£ç è°ƒç”¨setUiStyleæ–¹æ³•æ¥è®¾ç½®çª—å£çš„æ ·å¼ï¼Œæ˜¯ä½¿çª—å£é€æ˜æˆ–è€…åº”ç”¨å…¶ä»–è§†è§‰æ•ˆæœã€‚
        self.path = getcwd()
        self.video_path = getcwd()
        #è¿™é‡Œè®¾ç½®äº†ä¸¤ä¸ªè·¯å¾„å˜é‡ï¼Œself.pathå’Œself.video_pathï¼Œå®ƒä»¬éƒ½è¢«åˆå§‹åŒ–ä¸ºå½“å‰å·¥ä½œç›®å½•çš„è·¯å¾„ã€‚
        self.timer_camera = QtCore.QTimer()  # å®šæ—¶å™¨
        self.timer_video = QtCore.QTimer()  # è§†é¢‘å®šæ—¶å™¨
        self.flag_timer = ""  # ç”¨äºæ ‡è®°æ­£åœ¨è¿›è¡Œçš„åŠŸèƒ½é¡¹ï¼ˆè§†é¢‘/æ‘„åƒï¼‰

        self.LoadModel()  # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
        self.slot_init()  # å®šä¹‰æ§½å‡½æ•°ï¼Œè¿™æ˜¯Qtä¸­ç”¨äºå¤„ç†ä¿¡å·å’Œæ§½æœºåˆ¶çš„å‡½æ•°ï¼Œç”¨äºå“åº”äº‹ä»¶ã€‚
        self.files = []  #
        self.cap_video = None  # è§†é¢‘æµå¯¹è±¡
        self.CAM_NUM = 0  # æ‘„åƒå¤´æ ‡å·
        self.cap = cv2.VideoCapture(self.CAM_NUM)  # å±å¹•ç”»é¢å¯¹è±¡
        #è¿™å‡ è¡Œä»£ç åˆå§‹åŒ–äº†ä¸€äº›å˜é‡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç©ºåˆ—è¡¨self.filesï¼Œä¸€ä¸ªç©ºçš„è§†é¢‘æµå¯¹è±¡self.cap_videoï¼Œä¸€ä¸ªæ‘„åƒå¤´ç¼–å·self.CAM_NUMï¼Œä»¥åŠä½¿ç”¨cv2.VideoCaptureåˆ›å»ºçš„æ‘„åƒå¤´è§†é¢‘æ•è·å¯¹è±¡self.capã€‚
        self.detInfo = []
        self.current_image = []
        self.detected_image = None
        # self.dataset = None
        self.count = 0  # è¡¨æ ¼è¡Œæ•°ï¼Œç”¨äºè®°å½•è¯†åˆ«è¯†åˆ«æ¡ç›®
        self.res_set = []  # ç”¨äºå†å²ç»“æœè®°å½•çš„åˆ—è¡¨
        self.c_video = 0
        self.count_name = ["é»‘åŒ£å­"]
        self.count_table = []
        #è¿™ä¸€éƒ¨åˆ†åˆå§‹åŒ–äº†æ›´å¤šçš„å˜é‡ï¼ŒåŒ…æ‹¬ç”¨äºå­˜å‚¨æ£€æµ‹ä¿¡æ¯ã€å½“å‰å›¾åƒã€æ£€æµ‹åˆ°çš„å›¾åƒã€ç»“æœé›†å’Œå…¶ä»–ç›¸å…³æ•°æ®çš„åˆ—è¡¨å’Œå˜é‡ã€‚
```

1. è¯»å–é¢„è®­ç»ƒæ¨¡å‹

```python
def LoadModel(self, model_path=None):
        """
        è¯»å–é¢„è®­ç»ƒæ¨¡å‹
        """
        parser = argparse.ArgumentParser()
        parser.add_argument('--weights', nargs='+', type=str, default='../weights/best.pt',
                            help='model.pt path(s)')  # æ¨¡å‹è·¯å¾„ä»…æ”¯æŒ.ptæ–‡ä»¶
        parser.add_argument('--img-size', type=int, default=480, help='inference size (pixels)')  # æ£€æµ‹å›¾åƒå¤§å°ï¼Œä»…æ”¯æŒ480
        parser.add_argument('--conf-thres', type=float, default=0.25, help='object confidence threshold')  # ç½®ä¿¡åº¦é˜ˆå€¼
        parser.add_argument('--iou-thres', type=float, default=0.45, help='IOU threshold for NMS')  # NMSé˜ˆå€¼
        # é€‰ä¸­è¿è¡Œæœºå™¨çš„GPUæˆ–è€…cpuï¼Œæœ‰GPUåˆ™GPUï¼Œæ²¡æœ‰åˆ™cpuï¼Œè‹¥æƒ³ä»…ä½¿ç”¨cpuï¼Œå¯ä»¥å¡«cpuå³å¯
        parser.add_argument('--device', default='0',
                            help='cuda device, i.e. 0 or 0,1,2,3 or cpu')
        parser.add_argument('--save-dir', type=str, default='inference', help='directory to save results')  # æ–‡ä»¶ä¿å­˜è·¯å¾„
        parser.add_argument('--classes', nargs='+', type=int,
                            help='filter by class: --class 0, or --class 0 2 3')  # åˆ†å¼€ç±»åˆ«
        parser.add_argument('--agnostic-nms', action='store_true', help='class-agnostic NMS')  # ä½¿ç”¨NMS
        self.opt = parser.parse_args()  # optå±€éƒ¨å˜é‡ï¼Œé‡è¦
        out, weight, imgsz = self.opt.save_dir, self.opt.weights, self.opt.img_size  # å¾—åˆ°æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œæ–‡ä»¶æƒé‡è·¯å¾„ï¼Œå›¾åƒå°ºå¯¸
        self.device = select_device(self.opt.device)  # æ£€éªŒè®¡ç®—å•å…ƒ,gpuè¿˜æ˜¯cpu
        self.half = self.device.type != '0'  # å¦‚æœä½¿ç”¨gpuåˆ™è¿›è¡ŒåŠç²¾åº¦æ¨ç†
        if model_path:
            weight = model_path
        self.model = attempt_load(weight, map_location=self.device)  # è¯»å–æ¨¡å‹
        self.imgsz = check_img_size(imgsz, s=self.model.stride.max())  # æ£€æŸ¥å›¾åƒå°ºå¯¸
        if self.half:  # å¦‚æœæ˜¯åŠç²¾åº¦æ¨ç†
            self.model.half()  # è½¬æ¢æ¨¡å‹çš„æ ¼å¼
        self.names = self.model.module.names if hasattr(self.model, 'module') else self.model.names  # å¾—åˆ°æ¨¡å‹è®­ç»ƒçš„ç±»åˆ«å
    """
    è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸º `LoadModel` çš„æ–¹æ³•ï¼Œå®ƒç”¨äºåŠ è½½é¢„è®­ç»ƒçš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œå¹¶å¯¹æ¨¡å‹è¿›è¡Œä¸€äº›åˆå§‹åŒ–è®¾ç½®ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨äºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ¨ç†ï¼ˆinferenceï¼‰çš„å‡†å¤‡å·¥ä½œã€‚å…·ä½“æ¥çœ‹ï¼Œæ–¹æ³•çš„åŠŸèƒ½åŒ…æ‹¬ï¼š
1. **å‚æ•°è§£æ**ï¼š
   ä½¿ç”¨ `argparse` åº“æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚è¿™äº›å‚æ•°åŒ…æ‹¬æ¨¡å‹æƒé‡æ–‡ä»¶çš„è·¯å¾„ã€è¾“å…¥å›¾åƒçš„å¤§å°ã€ç½®ä¿¡åº¦é˜ˆå€¼ã€IOUé˜ˆå€¼ã€è®¡ç®—è®¾å¤‡ï¼ˆCPUæˆ–GPUï¼‰ã€ç»“æœä¿å­˜ç›®å½•ã€ç±»åˆ«è¿‡æ»¤ä»¥åŠæ˜¯å¦ä½¿ç”¨ç±»åˆ«æ— å…³çš„éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰ã€‚
2. **è®¾ç½®é»˜è®¤å‚æ•°**ï¼š
   å¦‚æœåœ¨è°ƒç”¨æ–¹æ³•æ—¶æ²¡æœ‰æŒ‡å®š `model_path`ï¼Œå®ƒä¼šä½¿ç”¨é»˜è®¤çš„å‚æ•°è®¾ç½®ã€‚
3. **é€‰æ‹©è®¡ç®—è®¾å¤‡**ï¼š
   ä½¿ç”¨ `select_device` å‡½æ•°ï¼ˆè¿™ä¸ªå‡½æ•°åœ¨ä»£ç ä¸­æ²¡æœ‰ç»™å‡ºï¼Œä½†å¯ä»¥æ¨æ–­å®ƒçš„åŠŸèƒ½æ˜¯é€‰æ‹©ä½¿ç”¨CPUè¿˜æ˜¯GPUè¿›è¡Œè®¡ç®—ï¼‰ã€‚
4. **æ¨¡å‹åŠ è½½**ï¼š
   ä½¿ç”¨ `attempt_load` å‡½æ•°åŠ è½½æ¨¡å‹ï¼Œè¿™ä¸ªå‡½æ•°å¯èƒ½æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°æˆ–è€…æ¥è‡ªæŸä¸ªåº“ï¼Œç”¨äºåŠ è½½æ¨¡å‹å¹¶å°†å…¶æ˜ å°„åˆ°æŒ‡å®šçš„è®¡ç®—è®¾å¤‡ä¸Šã€‚
5. **å›¾åƒå°ºå¯¸æ£€æŸ¥**ï¼š
   ä½¿ç”¨ `check_img_size` å‡½æ•°ç¡®ä¿è¾“å…¥å›¾åƒçš„å°ºå¯¸ä¸æ¨¡å‹çš„æ­¥é•¿å…¼å®¹ã€‚
6. **åŠç²¾åº¦æ¨ç†**ï¼š
   å¦‚æœè®¡ç®—è®¾å¤‡æ˜¯GPUï¼Œåˆ™å°†æ¨¡å‹è½¬æ¢ä¸ºåŠç²¾åº¦ï¼ˆfloat16ï¼‰ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«æ¨ç†é€Ÿåº¦å¹¶å‡å°‘å†…å­˜ä½¿ç”¨ã€‚
7. **ç±»åˆ«åç§°å¤„ç†**ï¼š
   è·å–æ¨¡å‹è®­ç»ƒæ—¶çš„ç±»åˆ«åç§°ï¼Œå¹¶ä¸”å¦‚æœè¿™äº›åç§°åœ¨ `Chinese_name` å­—å…¸ä¸­æœ‰å¯¹åº”çš„ä¸­æ–‡åç§°ï¼Œå°±æ›¿æ¢ä¸ºä¸­æ–‡åç§°ã€‚
8. **é¢œè‰²åˆ†é…**ï¼š
   ä¸ºæ¯ä¸ªç±»åˆ«åˆ†é…ä¸€ä¸ªé¢œè‰²ï¼Œè¿™é€šå¸¸ç”¨äºåœ¨å›¾åƒä¸Šç»˜åˆ¶æ£€æµ‹ç»“æœã€‚å¦‚æœç±»åˆ«çš„æ•°é‡æ²¡æœ‰è¶…è¿‡é¢„å®šä¹‰çš„é¢œè‰²åˆ—è¡¨ `color`ï¼Œå®ƒä¼šä½¿ç”¨è¿™äº›é¢œè‰²ï¼›å¦åˆ™ï¼Œä¼šéšæœºç”Ÿæˆé¢œè‰²ã€‚
9. **é¢„æ¨ç†**ï¼š
   åˆ›å»ºä¸€ä¸ªé›¶å›¾åƒå¼ é‡ï¼Œå¹¶é€šè¿‡æ¨¡å‹è¿›è¡Œä¸€æ¬¡å‰å‘ä¼ é€’ï¼Œè¿™é€šå¸¸æ˜¯ä¸ºäº†è®©æ¨¡å‹åœ¨å®é™…æ¨ç†ä¹‹å‰â€œçƒ­èº«â€ï¼Œç¡®ä¿CUDAæ ¸å¿ƒå·²ç»åŠ è½½ï¼Œä»è€Œåœ¨åç»­çš„æ¨ç†ä¸­èƒ½å¤Ÿæ›´å¿«ã€‚
è¿™ä¸ªæ–¹æ³•æ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹éƒ¨ç½²çš„å¸¸è§æ­¥éª¤çš„é›†åˆï¼Œç”¨äºå‡†å¤‡æ¨¡å‹è¿›è¡Œåç»­çš„å›¾åƒå¤„ç†å’Œå¯¹è±¡æ£€æµ‹ä»»åŠ¡ã€‚ä»£ç ä¸­æåˆ°çš„ä¸€äº›å‡½æ•°å’Œå˜é‡ï¼ˆå¦‚ `select_device`, `attempt_load`, `check_img_size`, `Chinese_name`ï¼‰æ²¡æœ‰åœ¨è¿™æ®µä»£ç ä¸­å®šä¹‰ï¼Œæ‰€ä»¥å®ƒä»¬çš„å…·ä½“å®ç°ç»†èŠ‚æ˜¯æœªçŸ¥çš„ï¼Œä½†ä»ä¸Šä¸‹æ–‡ä¸­å¯ä»¥æ¨æµ‹å®ƒä»¬çš„å¤§è‡´åŠŸèƒ½ã€‚
```

3.èåˆæ£€æµ‹ç¨‹åº-å¦‚ä¸Šé¢æ‰€å‘ˆç°

## åç»­å¤šæ¨¡æ€çš„èåˆ

---

åç»­å®ŒæˆåŸºç¡€å¯è§å…‰æ¡ä»¶çš„è®­ç»ƒä¹‹åï¼Œè¿˜è¦å°è¯•è¿›è¡Œå¤šå…‰è°±çš„èåˆï¼Œæé«˜æ¨¡å‹çš„ç²¾ç¡®åº¦ã€‚

# 20240413 ä¼šè®®çºªè¦

---

- æ˜ç¡®å¯æ£€æµ‹çš„å›¾ç‰‡ï¼Œè¿›è¡Œç•Œé™çš„åŒºåˆ†ï¼›
- åœ¨å¯è§å…‰æ¡ä»¶ä¸‹ï¼Œç•Œå®šé®æŒ¡æ¯”ä¾‹
- é»‘åŒ£å­å‡ºç°æç«¯ä½ç½®ï¼ˆä¾‹å¦‚å‚ç›´æ”¾ç½®æƒ…å†µä¸‹ï¼‰ï¼Œè¯†åˆ«çµæ•åº¦çš„æ§åˆ¶
- æ¼æ£€ç‡ä¸èƒ½ä½äº 5%
- æé«˜éªŒè¯é›†çš„æ•°é‡ï¼Œè¦æœ‰ç»Ÿè®¡ç»“æœï¼Œé…åˆå¯¼å‡ºæ£€æµ‹ç»“æœ
- æ›´æ”¹ GUI ç•Œé¢çš„é…è‰²
- ä½¿ç”¨å¤šå…‰è°±ç½‘ç»œæ¨¡å‹
- é¢„è®¡äº”æœˆåˆå¼€å§‹è®ºæ–‡çš„æ’°å†™

# æ€»ç»“

---

è¿™ç¯‡æ–‡ç« éšè¿›åº¦æ›´æ–°ï¼Œç”¨äºè®°å½•åœ¨æ¯•è®¾è¿‡ç¨‹ä¸­é‡åˆ°çš„å¿ƒå¾—å’Œé—®é¢˜ã€‚
